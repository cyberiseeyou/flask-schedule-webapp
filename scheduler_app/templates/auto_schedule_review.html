{% extends "base.html" %}

{% block title %}Review Auto-Schedule Proposal - Product Connections{% endblock %}

{% block extra_head %}
<style>
.review-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
}

.review-header {
    background: white;
    border-radius: 8px;
    padding: 30px;
    margin-bottom: 30px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.review-header h1 {
    color: #2c3e50;
    margin-bottom: 10px;
}

.review-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.stat-card {
    background: #f8f9fa;
    border-left: 4px solid #3498db;
    padding: 15px;
    border-radius: 4px;
}

.stat-card.success {
    border-left-color: #27ae60;
}

.stat-card.warning {
    border-left-color: #f39c12;
}

.stat-card.error {
    border-left-color: #e74c3c;
}

.stat-card h3 {
    margin: 0 0 5px 0;
    font-size: 14px;
    color: #7f8c8d;
    text-transform: uppercase;
}

.stat-card .value {
    font-size: 32px;
    font-weight: bold;
    color: #2c3e50;
}

.section {
    background: white;
    border-radius: 8px;
    padding: 25px;
    margin-bottom: 25px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.section h2 {
    color: #2c3e50;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 2px solid #3498db;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.section h2 .count-badge {
    background: #3498db;
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 14px;
}

.event-table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.event-table th {
    background: #f8f9fa;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: #34495e;
    border-bottom: 2px solid #dee2e6;
}

.event-table td {
    padding: 12px;
    border-bottom: 1px solid #dee2e6;
}

.event-table tr:hover {
    background: #f8f9fa;
}

.event-type-badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
}

.event-type-juicer {
    background: #e8f5e9;
    color: #2e7d32;
}

.event-type-digital {
    background: #e3f2fd;
    color: #1565c0;
}

.event-type-core {
    background: #fff3e0;
    color: #e65100;
}

.event-type-supervisor {
    background: #f3e5f5;
    color: #6a1b9a;
}

.event-type-freeosk {
    background: #fce4ec;
    color: #c2185b;
}

.swap-indicator {
    color: #f39c12;
    font-weight: bold;
}

.failure-reason {
    color: #e74c3c;
    font-style: italic;
}

.daily-preview {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 15px;
    margin-top: 15px;
}

.day-card {
    background: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 15px;
}

.day-card h4 {
    margin: 0 0 12px 0;
    color: #2c3e50;
    font-size: 16px;
    border-bottom: 1px solid #dee2e6;
    padding-bottom: 8px;
}

.day-card .event-item {
    padding: 8px;
    margin-bottom: 8px;
    background: white;
    border-radius: 4px;
    font-size: 13px;
}

.day-card .event-item .time {
    font-weight: bold;
    color: #3498db;
}

.day-card .event-item .employee {
    color: #7f8c8d;
}

.action-buttons {
    display: flex;
    gap: 15px;
    margin-top: 30px;
    padding-top: 20px;
    border-top: 2px solid #dee2e6;
}

.btn-approve {
    background-color: #27ae60;
    color: white;
    border: none;
    padding: 15px 40px;
    border-radius: 4px;
    font-size: 16px;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s;
}

.btn-approve:hover {
    background-color: #229954;
}

.btn-approve:disabled {
    background-color: #95a5a6;
    cursor: not-allowed;
}

.btn-reject {
    background-color: #e74c3c;
    color: white;
    border: none;
    padding: 15px 40px;
    border-radius: 4px;
    font-size: 16px;
    cursor: pointer;
    transition: background-color 0.3s;
}

.btn-reject:hover {
    background-color: #c0392b;
}

.btn-edit {
    background-color: #3498db;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 4px;
    font-size: 12px;
    cursor: pointer;
}

.btn-edit:hover {
    background-color: #2980b9;
}

.empty-state {
    text-align: center;
    padding: 40px;
    color: #7f8c8d;
}

.empty-state .icon {
    font-size: 48px;
    margin-bottom: 15px;
}

.alert {
    padding: 15px;
    border-radius: 4px;
    margin-bottom: 20px;
}

.alert-success {
    background-color: #d4edda;
    border: 1px solid #c3e6cb;
    color: #155724;
}

.alert-error {
    background-color: #f8d7da;
    border: 1px solid #f5c6cb;
    color: #721c24;
}

.alert-warning {
    background-color: #fff3cd;
    border: 1px solid #ffeaa7;
    color: #856404;
}

#message-container {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 1000;
    max-width: 400px;
}

.loading {
    text-align: center;
    padding: 40px;
    color: #7f8c8d;
}

.loading-spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}

{% block content %}
<div class="review-container">
    <div id="message-container"></div>

    {% if run %}
    <div class="review-header">
        <h1>Review Auto-Schedule Proposal</h1>
        <p>Review the proposed schedule changes below. You can edit individual assignments before approving.</p>

        <div class="review-stats" id="stats-container">
            <div class="stat-card success">
                <h3>Newly Scheduled</h3>
                <div class="value" id="stat-scheduled">-</div>
            </div>
            <div class="stat-card warning">
                <h3>Require Swaps</h3>
                <div class="value" id="stat-swaps">-</div>
            </div>
            <div class="stat-card error">
                <h3>Failed to Schedule</h3>
                <div class="value" id="stat-failed">-</div>
            </div>
            <div class="stat-card">
                <h3>Total Processed</h3>
                <div class="value" id="stat-total">-</div>
            </div>
        </div>
    </div>

    <!-- Newly Scheduled Events Section -->
    <div class="section">
        <h2>
            Newly Scheduled Events
            <span class="count-badge" id="count-scheduled">0</span>
        </h2>
        <div id="newly-scheduled-container">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading proposed schedules...</p>
            </div>
        </div>
    </div>

    <!-- Events Requiring Swaps Section -->
    <div class="section">
        <h2>
            Events Requiring Swaps
            <span class="count-badge" id="count-swaps">0</span>
        </h2>
        <div id="swaps-container">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading swap proposals...</p>
            </div>
        </div>
    </div>

    <!-- Daily Preview Section -->
    <div class="section">
        <h2>Daily Preview</h2>
        <div id="daily-preview-container" class="daily-preview">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading daily preview...</p>
            </div>
        </div>
    </div>

    <!-- Failed Events Section -->
    <div class="section">
        <h2>
            Failed to Schedule
            <span class="count-badge" id="count-failed">0</span>
        </h2>
        <div id="failed-container">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p>Loading failures...</p>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button type="button" class="btn-approve" id="approve-button" disabled>
            Approve Schedule
        </button>
        <button type="button" class="btn-reject" id="reject-button">
            Reject & Return to Dashboard
        </button>
    </div>

    {% else %}
    <div class="review-header">
        <h1>No Pending Proposals</h1>
        <div class="empty-state">
            <div class="icon">ðŸ“…</div>
            <p>{{ message or "There are no pending schedule proposals to review." }}</p>
            <p><a href="{{ url_for('main.dashboard') }}">Return to Dashboard</a></p>
        </div>
    </div>
    {% endif %}
</div>

<script>
document.addEventListener('DOMContentLoaded', async function() {
    {% if run %}
    const runId = {{ run.id }};
    const messageContainer = document.getElementById('message-container');

    function showMessage(message, type = 'success') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.textContent = message;
        messageContainer.appendChild(alertDiv);

        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }

    function getEventTypeBadge(eventType) {
        const typeClass = eventType.toLowerCase().replace(/\s+/g, '-');
        return `<span class="event-type-badge event-type-${typeClass}">${eventType}</span>`;
    }

    function formatDateTime(dateString, timeString) {
        if (!dateString) return '-';

        // Parse date as local time to avoid timezone issues
        // dateString format: "YYYY-MM-DD" or "YYYY-MM-DDTHH:MM:SS"
        const parts = dateString.split('T')[0].split('-');
        const year = parseInt(parts[0]);
        const month = parseInt(parts[1]) - 1; // Month is 0-indexed
        const day = parseInt(parts[2]);
        const date = new Date(year, month, day);

        const formatted = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        return timeString ? `${formatted} at ${timeString}` : formatted;
    }

    // Load pending schedules
    try {
        const response = await fetch('{{ url_for("auto_scheduler.get_pending_schedules") }}?run_id=' + runId);

        if (!response.ok) {
            const error = await response.json();
            showMessage('Error loading pending schedules: ' + (error.error || 'Unknown error'), 'error');
            return;
        }

        const data = await response.json();

        // Update stats
        document.getElementById('stat-scheduled').textContent = data.stats.events_scheduled;
        document.getElementById('stat-swaps').textContent = data.stats.events_requiring_swaps;
        document.getElementById('stat-failed').textContent = data.stats.events_failed;
        document.getElementById('stat-total').textContent = data.stats.total_events_processed;

        // Update count badges
        document.getElementById('count-scheduled').textContent = data.newly_scheduled.length;
        document.getElementById('count-swaps').textContent = data.swaps.length;
        document.getElementById('count-failed').textContent = data.failed.length;

        // Render newly scheduled
        const scheduledContainer = document.getElementById('newly-scheduled-container');
        if (data.newly_scheduled.length === 0) {
            scheduledContainer.innerHTML = '<div class="empty-state">No events newly scheduled in this run.</div>';
        } else {
            let html = '<table class="event-table">';
            html += '<thead><tr><th>Event</th><th>Type</th><th>Assigned To</th><th>Scheduled For</th><th>Actions</th></tr></thead><tbody>';
            data.newly_scheduled.forEach(event => {
                html += `<tr>
                    <td>${event.event_name}</td>
                    <td>${getEventTypeBadge(event.event_type)}</td>
                    <td>${event.employee_name}</td>
                    <td>${formatDateTime(event.schedule_date, event.schedule_time)}</td>
                    <td><button class="btn-edit" data-pending-id="${event.id}">Edit</button></td>
                </tr>`;
            });
            html += '</tbody></table>';
            scheduledContainer.innerHTML = html;
        }

        // Render swaps
        const swapsContainer = document.getElementById('swaps-container');
        if (data.swaps.length === 0) {
            swapsContainer.innerHTML = '<div class="empty-state">No swap proposals in this run.</div>';
        } else {
            let html = '<table class="event-table">';
            html += '<thead><tr><th>Event</th><th>Type</th><th>Assigned To</th><th>Scheduled For</th><th>Swap Reason</th><th>Actions</th></tr></thead><tbody>';
            data.swaps.forEach(event => {
                html += `<tr>
                    <td>${event.event_name}</td>
                    <td>${getEventTypeBadge(event.event_type)}</td>
                    <td>${event.employee_name}</td>
                    <td>${formatDateTime(event.schedule_date, event.schedule_time)}</td>
                    <td class="swap-indicator">${event.swap_reason || 'Conflict resolution'}</td>
                    <td><button class="btn-edit" data-pending-id="${event.id}">Edit</button></td>
                </tr>`;
            });
            html += '</tbody></table>';
            swapsContainer.innerHTML = html;
        }

        // Render daily preview
        const dailyContainer = document.getElementById('daily-preview-container');
        const sortedDates = Object.keys(data.daily_preview).sort();
        if (sortedDates.length === 0) {
            dailyContainer.innerHTML = '<div class="empty-state">No scheduled events to preview.</div>';
        } else {
            let html = '';
            sortedDates.forEach(dateStr => {
                const events = data.daily_preview[dateStr];

                // Parse date as local time to avoid timezone issues
                const parts = dateStr.split('-');
                const year = parseInt(parts[0]);
                const month = parseInt(parts[1]) - 1;
                const day = parseInt(parts[2]);
                const date = new Date(year, month, day);

                const formatted = date.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric' });

                html += `<div class="day-card">
                    <h4>${formatted}</h4>`;
                events.forEach(event => {
                    html += `<div class="event-item">
                        <div class="time">${event.schedule_time || '-'}</div>
                        <div>${event.event_name}</div>
                        <div class="employee">${event.employee_name}</div>
                    </div>`;
                });
                html += '</div>';
            });
            dailyContainer.innerHTML = html;
        }

        // Render failed
        const failedContainer = document.getElementById('failed-container');
        if (data.failed.length === 0) {
            failedContainer.innerHTML = '<div class="empty-state">âœ“ All events scheduled successfully!</div>';
        } else {
            let html = '<table class="event-table">';
            html += '<thead><tr><th>Event</th><th>Type</th><th>Failure Reason</th></tr></thead><tbody>';
            data.failed.forEach(event => {
                html += `<tr>
                    <td>${event.event_name}</td>
                    <td>${getEventTypeBadge(event.event_type)}</td>
                    <td class="failure-reason">${event.failure_reason || 'Unknown error'}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            failedContainer.innerHTML = html;
        }

        // Enable approve button if there are schedules to approve
        if (data.newly_scheduled.length > 0 || data.swaps.length > 0) {
            document.getElementById('approve-button').disabled = false;
        }

    } catch (error) {
        showMessage('Failed to load pending schedules: ' + error.message, 'error');
    }

    // Approve button handler
    document.getElementById('approve-button').addEventListener('click', async function() {
        if (!confirm('Approve this schedule and create all assignments? This action cannot be undone.')) {
            return;
        }

        this.disabled = true;
        this.textContent = 'Approving...';

        try {
            const response = await fetch('{{ url_for("auto_scheduler.approve_schedule") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ run_id: runId })
            });

            const data = await response.json();

            if (data.success) {
                showMessage('Schedule approved successfully! Redirecting...', 'success');
                setTimeout(() => {
                    window.location.href = '{{ url_for("main.dashboard") }}';
                }, 2000);
            } else {
                showMessage('Error approving schedule: ' + data.error, 'error');
                this.disabled = false;
                this.textContent = 'Approve Schedule';
            }
        } catch (error) {
            showMessage('Failed to approve schedule: ' + error.message, 'error');
            this.disabled = false;
            this.textContent = 'Approve Schedule';
        }
    });

    // Reject button handler
    document.getElementById('reject-button').addEventListener('click', async function() {
        if (!confirm('Reject ALL pending schedule proposals and return to dashboard? All proposed schedules will be permanently discarded.')) {
            return;
        }

        try {
            const response = await fetch('{{ url_for("auto_scheduler.reject_schedule") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    reject_all: true
                })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                showMessage(data.message, 'success');
                setTimeout(() => {
                    window.location.href = '{{ url_for("main.dashboard") }}';
                }, 1500);
            } else {
                showMessage('Error rejecting proposals: ' + (data.error || 'Unknown error'), 'error');
            }
        } catch (error) {
            showMessage('Failed to reject proposals: ' + error.message, 'error');
        }
    });

    // Edit button handlers (delegate to parent)
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('btn-edit')) {
            const pendingId = e.target.dataset.pendingId;
            // TODO: Implement edit modal
            showMessage('Edit functionality coming soon', 'warning');
        }
    });
    {% endif %}
});
</script>
{% endblock %}
