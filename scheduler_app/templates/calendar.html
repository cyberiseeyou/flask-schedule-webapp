{% extends "base.html" %}

{% block title %}Calendar - Product Connections Scheduler{% endblock %}
{% block page_title %}Calendar{% endblock %}

{% block extra_head %}
<style>
    .calendar-container {
        max-width: 1200px;
        margin: 0 auto;
    }
    
    .calendar-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
        padding: var(--spacing-md);
        background: var(--bg-secondary);
        border-radius: var(--border-radius-md);
        border: 1px solid rgba(46, 76, 115, 0.1);
    }
    
    .calendar-nav {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
    }
    
    .month-nav {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
    }
    
    .month-title {
        font-size: var(--font-size-h2);
        font-weight: var(--font-weight-bold);
        color: var(--text-primary);
        margin: 0;
        min-width: 200px;
        text-align: center;
    }
    
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 2px;
        background: rgba(46, 76, 115, 0.1);
        border-radius: var(--border-radius-md);
        overflow: hidden;
        box-shadow: var(--shadow-md);
    }
    
    .calendar-day-header {
        background: var(--pc-navy);
        color: var(--text-white);
        padding: var(--spacing-sm);
        text-align: center;
        font-weight: var(--font-weight-bold);
        font-size: var(--font-size-small);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .calendar-day {
        background: var(--bg-primary);
        min-height: 120px;
        padding: var(--spacing-xs);
        cursor: pointer;
        transition: all 0.2s ease;
        position: relative;
        border: 2px solid transparent;
    }
    
    .calendar-day:hover {
        background: var(--bg-secondary);
        border-color: var(--secondary-color);
    }
    
    .calendar-day.other-month {
        background: var(--bg-tertiary);
        opacity: 0.5;
    }
    
    .calendar-day.today {
        border-color: var(--primary-color);
        background: rgba(46, 76, 115, 0.05);
    }
    
    .calendar-day.has-events {
        background: rgba(27, 155, 216, 0.1);
    }
    
    .day-number {
        font-weight: var(--font-weight-bold);
        color: var(--text-primary);
        margin-bottom: var(--spacing-xs);
    }
    
    .day-events {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    
    .event-dot {
        height: 6px;
        border-radius: 3px;
        margin-bottom: 2px;
        opacity: 0.8;
    }
    
    .event-preview {
        font-size: 10px;
        background: var(--secondary-color);
        color: var(--text-white);
        padding: 1px 4px;
        border-radius: var(--border-radius-sm);
        margin-bottom: 1px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .events-count {
        position: absolute;
        top: 2px;
        right: 4px;
        background: var(--primary-color);
        color: var(--text-white);
        border-radius: 50%;
        width: 18px;
        height: 18px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 10px;
        font-weight: var(--font-weight-bold);
    }
    
    /* Day Detail Modal */
    .day-detail-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    .day-detail-content {
        background: var(--bg-primary);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-xl);
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: var(--shadow-lg);
        position: relative;
    }
    
    .modal-close {
        position: absolute;
        top: var(--spacing-md);
        right: var(--spacing-md);
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        color: var(--text-muted);
        padding: 0;
        width: 30px;
        height: 30px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .modal-close:hover {
        color: var(--text-primary);
    }
    
    .day-detail-header {
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-md);
        border-bottom: 2px solid var(--pc-light-blue);
    }
    
    .day-detail-title {
        font-size: var(--font-size-h2);
        color: var(--text-primary);
        margin: 0;
    }
    
    .day-events-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-md);
    }
    
    .day-event-card {
        background: var(--bg-secondary);
        border-radius: var(--border-radius-md);
        padding: var(--spacing-md);
        border-left: 4px solid var(--secondary-color);
    }
    
    .event-time {
        font-weight: var(--font-weight-bold);
        color: var(--primary-color);
        font-size: var(--font-size-small);
    }
    
    .event-name {
        font-weight: var(--font-weight-heading);
        color: var(--text-primary);
        margin: var(--spacing-xs) 0;
    }
    
    .event-details {
        font-size: var(--font-size-small);
        color: var(--text-muted);
        display: flex;
        gap: var(--spacing-md);
        flex-wrap: wrap;
    }
    
    .no-events {
        text-align: center;
        color: var(--text-muted);
        font-style: italic;
        padding: var(--spacing-xl);
    }
    
    .loading {
        text-align: center;
        padding: var(--spacing-xl);
        color: var(--text-muted);
    }
    
    .event-actions {
        display: flex;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-sm);
        flex-wrap: wrap;
    }
    
    .event-action-btn {
        padding: var(--spacing-xs) var(--spacing-sm);
        border: none;
        border-radius: var(--border-radius-sm);
        font-size: var(--font-size-small);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .btn-reschedule {
        background: var(--pc-blue);
        color: var(--text-white);
    }
    
    .btn-reschedule:hover {
        background: var(--pc-navy);
    }
    
    .btn-trade {
        background: var(--secondary-color);
        color: var(--text-white);
    }
    
    .btn-trade:hover {
        background: #0fa8ce;
    }
    
    .btn-change-employee {
        background: #28a745;
        color: var(--text-white);
    }
    
    .btn-change-employee:hover {
        background: #218838;
    }
    
    .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1001;
    }
    
    .action-modal {
        background: var(--bg-primary);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-xl);
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
        box-shadow: var(--shadow-lg);
        position: relative;
    }
    
    .action-modal h3 {
        margin-top: 0;
        color: var(--text-primary);
        border-bottom: 2px solid var(--pc-light-blue);
        padding-bottom: var(--spacing-sm);
    }
    
    .form-group {
        margin-bottom: var(--spacing-md);
    }
    
    .form-group label {
        display: block;
        margin-bottom: var(--spacing-xs);
        font-weight: var(--font-weight-bold);
        color: var(--text-primary);
    }
    
    .form-group input, .form-group select {
        width: 100%;
        padding: var(--spacing-sm);
        border: 1px solid #ddd;
        border-radius: var(--border-radius-sm);
        box-sizing: border-box;
    }
    
    .modal-actions {
        display: flex;
        gap: var(--spacing-sm);
        justify-content: flex-end;
        margin-top: var(--spacing-lg);
        padding-top: var(--spacing-md);
        border-top: 1px solid #ddd;
    }
    
    .hidden {
        display: none !important;
    }
</style>
{% endblock %}

{% block content %}
    <!-- Page Header -->
    <div class="page-header" style="text-align: center; margin-bottom: var(--spacing-lg); padding-bottom: var(--spacing-md); border-bottom: 2px solid var(--pc-light-blue);">
        <h1 class="page-title" style="font-size: var(--font-size-h1); font-weight: var(--font-weight-heading); color: var(--pc-navy); margin: 0; letter-spacing: -0.02em;">Calendar</h1>
    </div>

    <div class="calendar-container">
        <!-- Calendar Header -->
        <div class="calendar-header">
            <div class="month-nav">
                <button class="btn btn-outline" onclick="changeMonth(-1)">‹ Previous</button>
                <h2 class="month-title" id="month-title">{{ selected_date.strftime('%B %Y') }}</h2>
                <button class="btn btn-outline" onclick="changeMonth(1)">Next ›</button>
            </div>
            <div class="calendar-nav">
                <button class="btn btn-secondary" onclick="goToToday()">Today</button>
            </div>
        </div>

        <!-- Calendar Grid -->
        <div class="calendar-grid" id="calendar-grid">
            <!-- Day headers -->
            <div class="calendar-day-header">Sun</div>
            <div class="calendar-day-header">Mon</div>
            <div class="calendar-day-header">Tue</div>
            <div class="calendar-day-header">Wed</div>
            <div class="calendar-day-header">Thu</div>
            <div class="calendar-day-header">Fri</div>
            <div class="calendar-day-header">Sat</div>
            
            <!-- Calendar days will be generated by JavaScript -->
        </div>
    </div>

    <!-- Day Detail Modal -->
    <div class="day-detail-modal" id="day-detail-modal">
        <div class="day-detail-content">
            <button class="modal-close" onclick="closeDayDetail()">&times;</button>
            <div class="day-detail-header">
                <h2 class="day-detail-title" id="day-detail-title">Loading...</h2>
                
                <!-- Event Statistics -->
                <div class="event-statistics" id="event-statistics" style="margin: var(--spacing-md) 0; padding: var(--spacing-md); background: var(--bg-secondary); border-radius: var(--border-radius-md); border: 1px solid rgba(46, 76, 115, 0.1);">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-md); margin-bottom: var(--spacing-sm);">
                        <div class="stat-item">
                            <span class="stat-label" style="font-size: var(--font-size-small); color: var(--text-muted);">Total Core Events:</span>
                            <span class="stat-value" id="total-core" style="font-weight: var(--font-weight-bold); color: var(--pc-blue); font-size: var(--font-size-body);">0</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label" style="font-size: var(--font-size-small); color: var(--text-muted);">Total Digitals:</span>
                            <span class="stat-value" id="total-digitals" style="font-weight: var(--font-weight-bold); color: var(--pc-blue); font-size: var(--font-size-body);">0</span>
                        </div>
                    </div>
                    
                    <div class="core-time-stats" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: var(--spacing-sm); border-top: 1px solid rgba(46, 76, 115, 0.1); padding-top: var(--spacing-sm);">
                        <div class="time-stat" style="text-align: center;">
                            <div style="font-size: var(--font-size-small); color: var(--text-muted); margin-bottom: var(--spacing-xs);">9:45 AM</div>
                            <div class="time-count" id="core-945" style="font-weight: var(--font-weight-bold); color: var(--pc-navy); font-size: var(--font-size-body);">0</div>
                        </div>
                        <div class="time-stat" style="text-align: center;">
                            <div style="font-size: var(--font-size-small); color: var(--text-muted); margin-bottom: var(--spacing-xs);">10:30 AM</div>
                            <div class="time-count" id="core-1030" style="font-weight: var(--font-weight-bold); color: var(--pc-navy); font-size: var(--font-size-body);">0</div>
                        </div>
                        <div class="time-stat" style="text-align: center;">
                            <div style="font-size: var(--font-size-small); color: var(--text-muted); margin-bottom: var(--spacing-xs);">11:00 AM</div>
                            <div class="time-count" id="core-1100" style="font-weight: var(--font-weight-bold); color: var(--pc-navy); font-size: var(--font-size-body);">0</div>
                        </div>
                        <div class="time-stat" style="text-align: center;">
                            <div style="font-size: var(--font-size-small); color: var(--text-muted); margin-bottom: var(--spacing-xs);">11:30 AM</div>
                            <div class="time-count" id="core-1130" style="font-weight: var(--font-weight-bold); color: var(--pc-navy); font-size: var(--font-size-body);">0</div>
                        </div>
                    </div>
                </div>
                
                <div class="day-detail-actions" style="margin-top: var(--spacing-md); display: flex; justify-content: space-between; align-items: center;">
                    <div class="event-filters">
                        <label for="event-type-filter" style="margin-right: var(--spacing-sm);">Filter by Event Type:</label>
                        <select id="event-type-filter" onchange="filterEventsByType()" style="padding: var(--spacing-xs); border-radius: var(--border-radius-sm);">
                            <option value="all">All Events</option>
                            <option value="Core">Core</option>
                            <option value="Supervisor">Supervisor</option>
                            <option value="Freeosk">Freeosk</option>
                            <option value="Digitals">Digitals</option>
                            <option value="Other">Other</option>
                            <option value="Juicer">Juicer</option>
                        </select>
                    </div>
                    <button id="print-schedule-btn" class="btn btn-secondary" onclick="printDaySchedule()" style="margin-left: var(--spacing-md);">
                        Print Schedule
                    </button>
                </div>
            </div>
            <div class="day-events-list" id="day-events-list">
                <div class="loading">Loading events...</div>
            </div>
        </div>
    </div>

    <!-- Reschedule Event Modal -->
    <div class="modal-backdrop" id="reschedule-modal">
        <div class="action-modal">
            <button class="modal-close" onclick="closeModal('reschedule-modal')">&times;</button>
            <h3>Reschedule Event</h3>
            <form id="reschedule-form">
                <input type="hidden" id="reschedule-schedule-id">
                <div class="form-group">
                    <label>Event:</label>
                    <div id="reschedule-event-info"></div>
                </div>
                <div class="form-group">
                    <label for="reschedule-date">New Date:</label>
                    <input type="date" id="reschedule-date" required>
                </div>
                <div class="form-group">
                    <label for="reschedule-time">New Time:</label>
                    <input type="time" id="reschedule-time" required>
                    <select id="reschedule-time-dropdown" class="hidden">
                        <option value="">Select a time</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reschedule-employee">Employee:</label>
                    <select id="reschedule-employee" required>
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('reschedule-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Reschedule</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Trade Events Modal -->
    <div class="modal-backdrop" id="trade-modal">
        <div class="action-modal">
            <button class="modal-close" onclick="closeModal('trade-modal')">&times;</button>
            <h3>Trade Events</h3>
            <form id="trade-form">
                <input type="hidden" id="trade-schedule-id">
                <div class="form-group">
                    <label>Current Assignment:</label>
                    <div id="trade-current-info"></div>
                </div>
                <div class="form-group">
                    <label for="trade-with-employee">Trade With Employee:</label>
                    <select id="trade-with-employee" required>
                        <option value="">Select employee to trade with...</option>
                    </select>
                </div>
                <div id="trade-preview" class="form-group hidden">
                    <label>After Trade:</label>
                    <div id="trade-preview-info"></div>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('trade-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Trade Events</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Change Employee Modal -->
    <div class="modal-backdrop" id="change-employee-modal">
        <div class="action-modal">
            <button class="modal-close" onclick="closeModal('change-employee-modal')">&times;</button>
            <h3>Change Employee</h3>
            <form id="change-employee-form">
                <input type="hidden" id="change-schedule-id">
                <div class="form-group">
                    <label>Event Details:</label>
                    <div id="change-event-info"></div>
                </div>
                <div class="form-group">
                    <label for="change-new-employee">New Employee:</label>
                    <select id="change-new-employee" required>
                        <option value="">Select new employee...</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('change-employee-modal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Change Employee</button>
                </div>
            </form>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
    let currentDate = new Date('{{ selected_date.strftime('%Y-%m-%d') }}');
    let eventsData = {{ events_by_date | tojson }};
    
    // Initialize calendar
    document.addEventListener('DOMContentLoaded', function() {
        generateCalendar();
    });
    
    function generateCalendar() {
        const grid = document.getElementById('calendar-grid');
        const monthTitle = document.getElementById('month-title');
        
        // Update month title
        monthTitle.textContent = currentDate.toLocaleDateString('en-US', { 
            month: 'long', 
            year: 'numeric' 
        });
        
        // Clear existing days (keep headers)
        const days = grid.querySelectorAll('.calendar-day');
        days.forEach(day => day.remove());
        
        // Get first day of month and number of days
        const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
        const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());
        
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        
        // Generate 42 days (6 weeks)
        for (let i = 0; i < 42; i++) {
            const dayDate = new Date(startDate);
            dayDate.setDate(startDate.getDate() + i);
            
            const dayStr = dayDate.toISOString().split('T')[0];
            const isCurrentMonth = dayDate.getMonth() === currentDate.getMonth();
            const isToday = dayStr === todayStr;
            
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.dataset.date = dayStr;
            
            if (!isCurrentMonth) {
                dayElement.classList.add('other-month');
            }
            if (isToday) {
                dayElement.classList.add('today');
            }
            
            // Check if day has events
            const dayEvents = eventsData[dayStr] || [];
            if (dayEvents.length > 0) {
                dayElement.classList.add('has-events');
            }
            
            dayElement.innerHTML = `
                <div class="day-number">${dayDate.getDate()}</div>
                <div class="day-events">
                    ${dayEvents.slice(0, 3).map(event => 
                        `<div class="event-preview">${event.time}</div>`
                    ).join('')}
                </div>
                ${dayEvents.length > 3 ? `<div class="events-count">${dayEvents.length}</div>` : ''}
            `;
            
            dayElement.addEventListener('click', function() {
                showDayDetail(dayStr);
            });
            
            grid.appendChild(dayElement);
        }
    }
    
    function changeMonth(delta) {
        currentDate.setMonth(currentDate.getMonth() + delta);
        // Reload with new month
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('date', currentDate.toISOString().split('T')[0]);
        window.location.href = newUrl.toString();
    }
    
    function goToToday() {
        const today = new Date();
        const newUrl = new URL(window.location);
        newUrl.searchParams.set('date', today.toISOString().split('T')[0]);
        window.location.href = newUrl.toString();
    }
    
    function showDayDetail(dateStr) {
        const modal = document.getElementById('day-detail-modal');
        const title = document.getElementById('day-detail-title');
        const eventsList = document.getElementById('day-events-list');
        
        modal.style.display = 'flex';
        title.textContent = 'Loading...';
        eventsList.innerHTML = '<div class="loading">Loading events...</div>';
        
        // Fetch day events
        fetch(`/calendar/day/${dateStr}`)
            .then(response => response.json())
            .then(data => {
                // Store the current day's data for printing
                currentDayData = data;
                
                title.textContent = data.formatted_date;
                
                // Update event statistics
                updateEventStatistics(data.events);
                
                if (data.events.length === 0) {
                    eventsList.innerHTML = '<div class="no-events">No events scheduled for this day</div>';
                } else {
                    eventsList.innerHTML = data.events.map(event => `
                        <div class="day-event-card" data-event-type="${event.event_type}">
                            <div class="event-time">${event.time}</div>
                            <div class="event-name">${event.event_name}</div>
                            <div class="event-details">
                                <span class="event-type-badge event-type-${event.event_type.toLowerCase()}">${event.event_type}</span>
                                <span>👤 ${event.employee_name}</span>
                                ${event.store_name ? `<span>🏪 ${event.store_name}</span>` : ''}
                                ${event.estimated_time ? `<span>⏱️ ${event.estimated_time} min</span>` : ''}
                            </div>
                            <div class="event-actions">
                                <button class="event-action-btn btn-reschedule" 
                                        data-schedule-id="${event.id}"
                                        data-event-name="${event.event_name}"
                                        data-event-type="${event.event_type}"
                                        data-time="${event.time}"
                                        data-employee-name="${event.employee_name}"
                                        data-date="${data.date}">
                                    Reschedule
                                </button>
                                ${event.event_type === 'Core' ? `
                                    <button class="event-action-btn btn-trade"
                                            data-schedule-id="${event.id}"
                                            data-event-name="${event.event_name}"
                                            data-employee-name="${event.employee_name}"
                                            data-time="${event.time}"
                                            data-date="${data.date}">
                                        Trade
                                    </button>
                                ` : ''}
                                <button class="event-action-btn btn-change-employee"
                                        data-schedule-id="${event.id}"
                                        data-event-name="${event.event_name}"
                                        data-event-type="${event.event_type}"
                                        data-time="${event.time}"
                                        data-employee-name="${event.employee_name}"
                                        data-date="${data.date}">
                                    Change Employee
                                </button>
                            </div>
                        </div>
                    `).join('');
                    
                    // Add event listeners for the action buttons
                    setupEventActionListeners();
                }
            })
            .catch(error => {
                console.error('Error loading day events:', error);
                eventsList.innerHTML = '<div class="no-events">Error loading events</div>';
            });
    }
    
    function updateEventStatistics(events) {
        // Initialize counters
        let totalCore = 0;
        let totalDigitals = 0;
        let core945 = 0;
        let core1030 = 0;
        let core1100 = 0;
        let core1130 = 0;
        
        // Count events by type and Core events by time
        events.forEach(event => {
            if (event.event_type === 'Core') {
                totalCore++;
                
                // Convert time to check against Core time slots
                const time24 = convertTo24Hour(event.time);
                switch(time24) {
                    case '09:45':
                        core945++;
                        break;
                    case '10:30':
                        core1030++;
                        break;
                    case '11:00':
                        core1100++;
                        break;
                    case '11:30':
                        core1130++;
                        break;
                }
            } else if (event.event_type === 'Digitals') {
                totalDigitals++;
            }
        });
        
        // Update the display
        document.getElementById('total-core').textContent = totalCore;
        document.getElementById('total-digitals').textContent = totalDigitals;
        document.getElementById('core-945').textContent = core945;
        document.getElementById('core-1030').textContent = core1030;
        document.getElementById('core-1100').textContent = core1100;
        document.getElementById('core-1130').textContent = core1130;
    }
    
    function setupEventActionListeners() {
        // Add event listeners for reschedule buttons
        document.querySelectorAll('.btn-reschedule').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const scheduleId = this.dataset.scheduleId;
                const eventName = this.dataset.eventName;
                const eventType = this.dataset.eventType;
                const time = this.dataset.time;
                const employeeName = this.dataset.employeeName;
                const date = this.dataset.date;
                
                openRescheduleModal(scheduleId, eventName, eventType, time, employeeName, date);
            });
        });
        
        // Add event listeners for change employee buttons
        document.querySelectorAll('.btn-change-employee').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const scheduleId = this.dataset.scheduleId;
                const eventName = this.dataset.eventName;
                const eventType = this.dataset.eventType;
                const time = this.dataset.time;
                const employeeName = this.dataset.employeeName;
                const date = this.dataset.date;
                
                openChangeEmployeeModal(scheduleId, eventName, eventType, time, employeeName, date);
            });
        });
        
        // Add event listeners for trade buttons
        document.querySelectorAll('.btn-trade').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const scheduleId = this.dataset.scheduleId;
                const eventName = this.dataset.eventName;
                const employeeName = this.dataset.employeeName;
                const time = this.dataset.time;
                const date = this.dataset.date;
                
                openTradeModal(scheduleId, eventName, employeeName, time, date);
            });
        });
    }
    
    // Global variable to store current day's data for printing
    let currentDayData = null;
    
    function printDaySchedule() {
        if (!currentDayData || !currentDayData.events) {
            alert('No events data available for printing.');
            return;
        }
        
        // Filter for Core events and Juicer Production events only (excluding surveys)
        const printableEvents = currentDayData.events.filter(event => {
            return event.event_type === 'Core' || 
                   (event.event_type === 'Juicer' && 
                    event.event_name.includes('Production') && 
                    !event.event_name.toLowerCase().includes('survey'));
        });
        
        if (printableEvents.length === 0) {
            alert('No Core or Juicer Production events found for this day.');
            return;
        }
        
        // Sort events by scheduled time
        printableEvents.sort((a, b) => {
            // Convert time strings to comparable format
            const timeA = convertTimeToMinutes(a.time);
            const timeB = convertTimeToMinutes(b.time);
            return timeA - timeB;
        });
        
        // Generate printable HTML
        const printContent = generatePrintableSchedule(currentDayData.formatted_date, printableEvents);
        
        // Create and open print window
        const printWindow = window.open('', '_blank');
        printWindow.document.write(printContent);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
    }
    
    function convertTimeToMinutes(timeStr) {
        // Convert time like "9:15 AM" to minutes for sorting
        const [time, modifier] = timeStr.split(' ');
        const [hours, minutes] = time.split(':');
        let hour = parseInt(hours);
        
        if (modifier === 'PM' && hour !== 12) {
            hour += 12;
        } else if (modifier === 'AM' && hour === 12) {
            hour = 0;
        }
        
        return hour * 60 + parseInt(minutes);
    }
    
    function generatePrintableSchedule(dateStr, printableEvents) {
        return `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Core Events Schedule - ${dateStr}</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    margin: 40px;
                    background: white;
                }
                .header {
                    text-align: center;
                    margin-bottom: 30px;
                    border-bottom: 3px solid #2E4C73;
                    padding-bottom: 20px;
                }
                .date-title {
                    font-size: 24px;
                    font-weight: bold;
                    color: #2E4C73;
                    margin: 0;
                }
                .subtitle {
                    font-size: 16px;
                    color: #666;
                    margin: 5px 0 0 0;
                }
                .schedule-table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-top: 20px;
                }
                .schedule-table th {
                    background: #2E4C73;
                    color: white;
                    padding: 12px;
                    text-align: left;
                    font-weight: bold;
                    font-size: 14px;
                    border: 1px solid #ddd;
                }
                .schedule-table td {
                    padding: 10px 12px;
                    border: 1px solid #ddd;
                    font-size: 13px;
                }
                .schedule-table tr:nth-child(even) {
                    background-color: #f9f9f9;
                }
                .schedule-table tr:hover {
                    background-color: #f0f0f0;
                }
                .employee-name {
                    font-weight: bold;
                    color: #2E4C73;
                }
                .event-time {
                    font-weight: bold;
                    color: #1B9BD8;
                }
                .event-name {
                    color: #333;
                }
                .footer {
                    margin-top: 40px;
                    text-align: center;
                    font-size: 12px;
                    color: #888;
                    border-top: 1px solid #ddd;
                    padding-top: 20px;
                }
                @media print {
                    body { margin: 20px; }
                    .header { page-break-after: avoid; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <h1 class="date-title">${dateStr}</h1>
                <p class="subtitle">Daily Schedule</p>
            </div>
            
            <table class="schedule-table">
                <thead>
                    <tr>
                        <th style="width: 30%;">Employee Name</th>
                        <th style="width: 20%;">Scheduled Time</th>
                        <th style="width: 50%;">Event Name</th>
                    </tr>
                </thead>
                <tbody>
                    ${printableEvents.map(event => `
                        <tr>
                            <td class="employee-name">${event.employee_name}</td>
                            <td class="event-time">${event.time}</td>
                            <td class="event-name">${event.event_name}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            
            <div class="footer">
                <p>Generated on ${new Date().toLocaleString()} | Product Connections Scheduler</p>
            </div>
        </body>
        </html>
        `;
    }
    
    function closeDayDetail() {
        document.getElementById('day-detail-modal').style.display = 'none';
    }
    
    // Close modal when clicking outside
    document.getElementById('day-detail-modal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDayDetail();
        }
    });
    
    // Event filtering function
    function filterEventsByType() {
        const selectedType = document.getElementById('event-type-filter').value;
        const eventCards = document.querySelectorAll('.day-event-card');
        
        eventCards.forEach(card => {
            if (selectedType === 'all' || card.dataset.eventType === selectedType) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }
    
    // Modal management functions
    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
    
    // Close modals when clicking outside
    document.querySelectorAll('.modal-backdrop').forEach(modal => {
        modal.addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal(this.id);
            }
        });
    });
    
    // Reschedule Modal Functions
    function openRescheduleModal(scheduleId, eventName, eventType, currentTime, employeeName, currentDate) {
        try {
            document.getElementById('reschedule-schedule-id').value = scheduleId;
            document.getElementById('reschedule-event-info').innerHTML = `
                <strong>${eventName}</strong> (${eventType})<br>
                Current: ${currentDate} at ${currentTime} with ${employeeName}
            `;
            
            // Convert displayed time to 24-hour format for comparison
            const time24 = convertTo24Hour(currentTime);
            
            // Set up time restrictions for event type
            setupTimeRestrictions('reschedule', eventType, time24);
            
            // Load available employees with role-based filtering
            loadAvailableEmployeesForReschedule('reschedule-employee', currentDate, eventType);
            
            document.getElementById('reschedule-modal').style.display = 'flex';
        } catch (error) {
            console.error('Error opening reschedule modal:', error);
            alert('Error opening reschedule modal. Please try again.');
        }
    }
    
    // Trade Modal Functions  
    function openTradeModal(scheduleId, eventName, employeeName, time, date) {
        document.getElementById('trade-schedule-id').value = scheduleId;
        document.getElementById('trade-current-info').innerHTML = `
            <strong>${eventName}</strong><br>
            ${employeeName} at ${time}
        `;
        
        // Load employees with Core events on the same date
        loadCoreEmployeesForTrade(date, scheduleId);
        
        document.getElementById('trade-modal').style.display = 'flex';
    }
    
    // Change Employee Modal Functions
    function openChangeEmployeeModal(scheduleId, eventName, eventType, time, employeeName, date) {
        try {
            document.getElementById('change-schedule-id').value = scheduleId;
            document.getElementById('change-event-info').innerHTML = `
                <strong>${eventName}</strong> (${eventType})<br>
                Date: ${date} at ${time}<br>
                Current Employee: ${employeeName}
            `;
            
            // Load available employees for this date (excluding Core-scheduled employees if this is a Core event)
            loadAvailableEmployeesForChange(date, eventType);
            
            document.getElementById('change-employee-modal').style.display = 'flex';
        } catch (error) {
            console.error('Error opening change employee modal:', error);
            alert('Error opening change employee modal. Please try again.');
        }
    }
    
    // Helper function to setup time restrictions
    function setupTimeRestrictions(prefix, eventType, currentTime) {
        const timeInput = document.getElementById(prefix + '-time');
        const timeDropdown = document.getElementById(prefix + '-time-dropdown');
        
        const timeRestrictions = {
            'Core': ['09:45', '10:30', '11:00', '11:30'],
            'Supervisor': ['12:00'],
            'Freeosk': ['09:00', '12:00'],
            'Digitals': ['09:15', '09:30', '09:45', '10:00']
        };
        
        if (timeRestrictions[eventType]) {
            timeInput.style.display = 'none';
            timeInput.required = false;
            timeDropdown.style.display = 'block';
            timeDropdown.required = true;
            timeDropdown.classList.remove('hidden');
            
            timeDropdown.innerHTML = '<option value="">Select a time</option>';
            timeRestrictions[eventType].forEach(time => {
                const option = document.createElement('option');
                option.value = time;
                option.textContent = formatTime(time);
                if (currentTime && time === currentTime) {
                    option.selected = true;
                }
                timeDropdown.appendChild(option);
            });
            
            // Set default value for Freeosk events if no current time matches
            if (eventType === 'Freeosk' && currentTime && !timeRestrictions[eventType].includes(currentTime)) {
                timeDropdown.value = '09:00';
            }
        } else {
            timeInput.style.display = 'block';
            timeInput.required = true;
            timeDropdown.style.display = 'none';
            timeDropdown.required = false;
            timeDropdown.classList.add('hidden');
        }
    }
    
    // Helper function to format time
    function formatTime(time24) {
        const [hours, minutes] = time24.split(':');
        const hour = parseInt(hours);
        const ampm = hour >= 12 ? 'PM' : 'AM';
        const displayHour = hour === 0 ? 12 : hour > 12 ? hour - 12 : hour;
        return `${displayHour}:${minutes} ${ampm}`;
    }
    
    // Helper function to convert 12-hour time to 24-hour time
    function convertTo24Hour(time12) {
        if (!time12 || !time12.includes(':')) {
            return time12; // Return as-is if not valid format
        }
        
        const [time, modifier] = time12.split(' ');
        if (!modifier) {
            return time12; // Already in 24-hour format
        }
        
        const [hours, minutes] = time.split(':');
        let hour = parseInt(hours);
        
        if (modifier.toUpperCase() === 'PM' && hour !== 12) {
            hour += 12;
        } else if (modifier.toUpperCase() === 'AM' && hour === 12) {
            hour = 0;
        }
        
        return `${hour.toString().padStart(2, '0')}:${minutes}`;
    }
    
    // Load available employees functions
    function loadAvailableEmployees(selectId, date) {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Loading...</option>';
        
        fetch(`/api/available_employees/${date}`)
            .then(response => response.json())
            .then(employees => {
                select.innerHTML = '<option value="">Select an employee</option>';
                employees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = `${employee.name} (${employee.job_title})`;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading employees:', error);
                select.innerHTML = '<option value="">Error loading employees</option>';
            });
    }
    
    function loadAvailableEmployeesForReschedule(selectId, date, eventType) {
        const select = document.getElementById(selectId);
        select.innerHTML = '<option value="">Loading...</option>';
        
        fetch(`/api/available_employees_for_change/${date}/${eventType}`)
            .then(response => response.json())
            .then(employees => {
                select.innerHTML = '<option value="">Select an employee</option>';
                employees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = `${employee.name} (${employee.job_title})`;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading employees:', error);
                select.innerHTML = '<option value="">Error loading employees</option>';
            });
    }
    
    function loadCoreEmployeesForTrade(date, currentScheduleId) {
        const select = document.getElementById('trade-with-employee');
        select.innerHTML = '<option value="">Loading...</option>';
        
        fetch(`/api/core_employees_for_trade/${date}/${currentScheduleId}`)
            .then(response => response.json())
            .then(employees => {
                if (employees.length === 0) {
                    select.innerHTML = '<option value="">No other Core events to trade with</option>';
                } else {
                    select.innerHTML = '<option value="">Select employee to trade with...</option>';
                    employees.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.schedule_id;
                        option.textContent = `${emp.employee_name} - ${emp.event_name} at ${emp.time}`;
                        select.appendChild(option);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading trade employees:', error);
                select.innerHTML = '<option value="">Error loading employees</option>';
            });
    }
    
    function loadAvailableEmployeesForChange(date, eventType) {
        const select = document.getElementById('change-new-employee');
        select.innerHTML = '<option value="">Loading...</option>';
        
        fetch(`/api/available_employees_for_change/${date}/${eventType}`)
            .then(response => response.json())
            .then(employees => {
                select.innerHTML = '<option value="">Select new employee...</option>';
                employees.forEach(employee => {
                    const option = document.createElement('option');
                    option.value = employee.id;
                    option.textContent = `${employee.name} (${employee.job_title})`;
                    select.appendChild(option);
                });
            })
            .catch(error => {
                console.error('Error loading employees:', error);
                select.innerHTML = '<option value="">Error loading employees</option>';
            });
    }
    
    // Form submission handlers
    document.getElementById('reschedule-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const scheduleId = document.getElementById('reschedule-schedule-id').value;
        const date = document.getElementById('reschedule-date').value;
        const timeInput = document.getElementById('reschedule-time');
        const timeDropdown = document.getElementById('reschedule-time-dropdown');
        const time = timeDropdown.style.display !== 'none' ? timeDropdown.value : timeInput.value;
        const employeeId = document.getElementById('reschedule-employee').value;
        
        if (!date || !time || !employeeId) {
            alert('Please fill in all fields');
            return;
        }
        
        fetch('/api/reschedule_event', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                schedule_id: parseInt(scheduleId),
                date: date,
                time: time,
                employee_id: employeeId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                closeModal('reschedule-modal');
                location.reload(); // Refresh calendar
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error rescheduling event');
        });
    });
    
    document.getElementById('trade-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const scheduleId = document.getElementById('trade-schedule-id').value;
        const tradeWithScheduleId = document.getElementById('trade-with-employee').value;
        
        if (!tradeWithScheduleId) {
            alert('Please select an employee to trade with');
            return;
        }
        
        fetch('/api/trade_events', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                schedule_id: parseInt(scheduleId),
                trade_with_schedule_id: parseInt(tradeWithScheduleId)
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                closeModal('trade-modal');
                location.reload(); // Refresh calendar
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error trading events');
        });
    });
    
    document.getElementById('change-employee-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const scheduleId = document.getElementById('change-schedule-id').value;
        const newEmployeeId = document.getElementById('change-new-employee').value;
        
        if (!newEmployeeId) {
            alert('Please select a new employee');
            return;
        }
        
        fetch('/api/change_employee', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                schedule_id: parseInt(scheduleId),
                employee_id: newEmployeeId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                closeModal('change-employee-modal');
                location.reload(); // Refresh calendar
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error changing employee');
        });
    });
</script>
{% endblock %}