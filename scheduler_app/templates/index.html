{% extends "base.html" %}

{% block title %}Dashboard - Product Connections Scheduler{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block extra_head %}
<style>
    .page-header {
        text-align: center;
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-md);
        border-bottom: 2px solid var(--pc-light-blue);
    }
    
    .page-title {
        font-size: var(--font-size-h1);
        font-weight: var(--font-weight-heading);
        color: var(--pc-navy);
        margin: 0;
        letter-spacing: -0.02em;
    }

    .welcome-section {
        background: var(--bg-primary);
        border: 2px solid var(--pc-light-blue);
        padding: var(--spacing-xl);
        border-radius: var(--border-radius-lg);
        margin-bottom: var(--spacing-lg);
        box-shadow: var(--shadow-sm);
        position: relative;
        overflow: hidden;
    }

    .welcome-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 6px;
        background: linear-gradient(90deg, var(--pc-navy) 0%, var(--pc-blue) 100%);
    }

    .welcome-content {
        text-align: center;
        position: relative;
        z-index: 2;
    }

    .welcome-title {
        font-size: 2.5rem;
        font-weight: var(--font-weight-bold);
        color: var(--pc-navy);
        margin-bottom: var(--spacing-sm);
        text-shadow: none;
    }

    .welcome-subtitle {
        font-size: 1.1rem;
        color: var(--text-muted);
        font-weight: var(--font-weight-body);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
    }

    .stat-card {
        background: var(--bg-primary);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-xl);
        box-shadow: var(--shadow-sm);
        text-align: center;
        border: 1px solid rgba(46, 76, 115, 0.08);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--pc-blue) 0%, var(--pc-navy) 100%);
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }

    .stat-card:hover {
        box-shadow: var(--shadow-lg);
        transform: translateY(-4px);
        border-color: var(--pc-light-blue);
    }

    .stat-card:hover::before {
        transform: scaleX(1);
    }

    .stat-number {
        font-size: 3rem;
        font-weight: 700;
        color: var(--pc-navy);
        margin-bottom: var(--spacing-sm);
        line-height: 1;
        background: linear-gradient(135deg, var(--pc-navy) 0%, var(--pc-blue) 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: var(--font-size-small);
        font-weight: var(--font-weight-heading);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin: 0;
    }

    .dashboard-sections {
        display: grid;
        grid-template-columns: 1fr;
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
    }

    .dashboard-section {
        background: var(--bg-primary);
        border-radius: var(--border-radius-lg);
        padding: var(--spacing-xl);
        box-shadow: var(--shadow-sm);
        border: 1px solid rgba(46, 76, 115, 0.08);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .dashboard-section::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--pc-navy) 0%, var(--pc-blue) 100%);
    }

    .dashboard-section:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-2px);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-md);
        border-bottom: 1px solid rgba(46, 76, 115, 0.1);
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--pc-navy);
        margin: 0;
        letter-spacing: -0.02em;
    }

    .time-slot-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: var(--spacing-sm);
        margin-bottom: var(--spacing-md);
    }

    .time-slot {
        background: var(--bg-primary);
        padding: var(--spacing-md);
        border-radius: var(--border-radius-md);
        text-align: center;
        border: 2px solid var(--pc-light-blue);
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
    }

    .time-slot:hover {
        border-color: var(--pc-blue);
        box-shadow: 0 4px 12px rgba(27, 155, 216, 0.15);
        transform: translateY(-2px);
    }

    .time-slot-time {
        font-weight: 500;
        color: var(--text-secondary);
        font-size: var(--font-size-small);
        margin-bottom: var(--spacing-xs);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .time-slot-count {
        font-size: 2rem;
        color: var(--pc-navy);
        font-weight: 700;
        margin: 0;
        line-height: 1;
    }

    .core-events-list {
        max-height: 300px;
        overflow-y: auto;
    }

    .core-event-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: var(--spacing-sm);
        border-radius: var(--border-radius-sm);
        margin-bottom: var(--spacing-xs);
        background: var(--bg-secondary);
        border: 1px solid rgba(46, 76, 115, 0.05);
        transition: all 0.2s ease;
    }

    .core-event-item:last-child {
        margin-bottom: 0;
    }

    .core-event-item:hover {
        background: var(--bg-primary);
        box-shadow: var(--shadow-sm);
        border-color: var(--pc-light-blue);
        transform: translateX(4px);
    }

    .core-event-time {
        font-weight: 600;
        color: var(--pc-navy);
        font-size: var(--font-size-small);
        background: rgba(46, 76, 115, 0.1);
        padding: 2px 6px;
        border-radius: 3px;
        text-align: center;
        flex-shrink: 0;
    }

    .core-event-employee {
        color: var(--text-primary);
        font-weight: 500;
        flex-shrink: 0;
    }

    .core-event-name {
        color: var(--text-secondary);
        font-size: var(--font-size-small);
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        font-style: italic;
        flex: 1;
    }

    .unscheduled-list {
        max-height: 400px;
        overflow-y: auto;
    }

    .unscheduled-item {
        background: var(--bg-primary);
        border-radius: var(--border-radius-md);
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-sm);
        border: 1px solid rgba(46, 76, 115, 0.1);
        transition: all 0.2s ease;
        position: relative;
    }

    .unscheduled-item:last-child {
        margin-bottom: 0;
    }

    .unscheduled-item:hover {
        box-shadow: var(--shadow-sm);
        border-color: var(--pc-light-blue);
        transform: translateY(-2px);
    }

    .unscheduled-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--spacing-xs);
    }

    .unscheduled-title {
        font-weight: 500;
        color: var(--text-primary);
        font-size: var(--font-size-small);
        flex: 1;
        margin-right: var(--spacing-sm);
        line-height: 1.4;
    }

    .unscheduled-dates {
        font-size: var(--font-size-small);
        color: var(--text-muted);
        background: var(--bg-secondary);
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 500;
    }

    .percentage-display {
        text-align: center;
        background: linear-gradient(135deg, var(--pc-light-blue) 0%, rgba(232, 244, 249, 0.7) 100%);
        padding: var(--spacing-xl);
        border-radius: var(--border-radius-lg);
        margin-bottom: var(--spacing-lg);
        border: 1px solid rgba(27, 155, 216, 0.2);
        position: relative;
        overflow: hidden;
    }

    .percentage-display::before {
        content: '';
        position: absolute;
        top: -2px;
        left: -2px;
        right: -2px;
        bottom: -2px;
        background: linear-gradient(135deg, var(--pc-blue), var(--pc-navy));
        z-index: -1;
        border-radius: var(--border-radius-lg);
        opacity: 0.1;
    }

    .percentage-number {
        font-size: 4rem;
        font-weight: 800;
        color: var(--pc-navy);
        margin-bottom: var(--spacing-sm);
        line-height: 1;
        text-shadow: 0 2px 4px rgba(46, 76, 115, 0.1);
    }

    .percentage-label {
        color: var(--text-secondary);
        font-size: var(--font-size-body);
        font-weight: 500;
        margin: 0;
    }

    .no-items {
        text-align: center;
        color: var(--text-muted);
        font-style: italic;
        padding: var(--spacing-lg);
    }

    .print-schedule-section {
        display: flex;
        justify-content: space-between;
        gap: var(--spacing-md);
        margin-top: var(--spacing-lg);
        padding: var(--spacing-md) 0;
        border-top: 1px solid rgba(46, 76, 115, 0.1);
        position: relative;
    }
    
    .print-schedule-section .btn {
        flex: 1;
    }

    .print-schedule-section::before {
        content: '';
        position: absolute;
        top: -1px;
        left: 50%;
        transform: translateX(-50%);
        width: 60px;
        height: 2px;
        background: linear-gradient(90deg, var(--pc-blue), var(--pc-navy));
    }

    @media (max-width: 768px) {
        .stats-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .time-slot-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
    <!-- Page Header -->
    <div class="page-header">
        <h1 class="page-title">Dashboard</h1>
    </div>

    <!-- Welcome Section -->
    <div class="welcome-section">
        <div class="welcome-content">
            <h2 class="welcome-title">
                Welcome {% if supervisor_first_name %}{{ supervisor_first_name }}{% else %}Club Supervisor{% endif %}
            </h2>
            <p class="welcome-subtitle">{{ today.strftime('%A, %B %d, %Y') }}</p>
        </div>
    </div>

    <!-- Statistics Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-number">{{ total_core_today }}</div>
            <div class="stat-label">Core Events Today</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ total_digitals_today }}</div>
            <div class="stat-label">Digital Events Today</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ active_employees_count }}</div>
            <div class="stat-label">Active Employees</div>
        </div>
        <div class="stat-card">
            <div class="stat-number">{{ events_this_week }}</div>
            <div class="stat-label">Events This Week</div>
        </div>
    </div>

    <!-- Auto-Scheduler Section -->
    <div id="auto-scheduler-notification" style="display: none; background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); color: white; border-radius: 8px; padding: 20px; margin-bottom: 30px; box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3); animation: pulse 2s ease-in-out infinite;">
        <div style="display: flex; align-items: center; justify-content: space-between;">
            <div style="flex: 1;">
                <h3 style="margin: 0 0 5px 0; font-size: 1.3rem;">⚠️ Pending Schedule Proposal</h3>
                <p style="margin: 0; opacity: 0.9; font-size: 0.95rem;">A proposed schedule is ready for your review.</p>
            </div>
            <a href="{{ url_for('auto_scheduler.review') }}" class="btn" style="background: white; color: #e67e22; font-weight: bold; padding: 12px 24px; text-decoration: none; border-radius: 4px; transition: transform 0.2s;">
                Review Now
            </a>
        </div>
    </div>

    <style>
    @keyframes pulse {
        0%, 100% { transform: scale(1); box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3); }
        50% { transform: scale(1.01); box-shadow: 0 6px 16px rgba(243, 156, 18, 0.4); }
    }
    </style>

    <!-- Auto-Scheduler Controls -->
    <div class="dashboard-section" style="background: linear-gradient(135deg, #e8f5e9 0%, #f1f8f4 100%); border-left: 4px solid #27ae60;">
        <div class="section-header">
            <h3 class="section-title">🤖 Auto-Scheduler</h3>
            <a href="{{ url_for('rotations.index') }}" class="btn btn-outline" style="font-size: 0.9em; padding: 0.5rem 1rem;">
                Configure Rotations
            </a>
        </div>

        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 20px; align-items: center;">
            <div>
                <p style="color: var(--text-secondary); margin-bottom: 15px; line-height: 1.6;">
                    The auto-scheduler will analyze unscheduled events within the next 3 weeks and create
                    assignment proposals based on weekly rotations, employee availability, and event priorities.
                </p>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <button onclick="runAutoScheduler()" id="auto-schedule-btn" class="btn btn-primary">
                        Run Auto-Scheduler
                    </button>
                    <span id="auto-schedule-status" style="color: var(--text-muted); font-size: 0.9rem;"></span>
                </div>
            </div>
            <div id="last-run-info" style="background: white; padding: 15px; border-radius: 6px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
                <div style="font-size: 0.85rem; color: #7f8c8d; margin-bottom: 5px;">Last Run</div>
                <div id="last-run-time" style="font-weight: 600; color: #2c3e50;">Never</div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard Sections -->
    <div class="dashboard-sections">
        <!-- Today's Core Events -->
        <div class="dashboard-section">
            <div class="section-header">
                <h3 class="section-title">Today's Core Events</h3>
            </div>
            
            <!-- Core Time Slots Summary -->
            <div class="time-slot-grid">
                <div class="time-slot">
                    <div class="time-slot-time">9:45 AM</div>
                    <div class="time-slot-count">{{ core_time_slots['9:45'] }}</div>
                </div>
                <div class="time-slot">
                    <div class="time-slot-time">10:30 AM</div>
                    <div class="time-slot-count">{{ core_time_slots['10:30'] }}</div>
                </div>
                <div class="time-slot">
                    <div class="time-slot-time">11:00 AM</div>
                    <div class="time-slot-count">{{ core_time_slots['11:00'] }}</div>
                </div>
                <div class="time-slot">
                    <div class="time-slot-time">11:30 AM</div>
                    <div class="time-slot-count">{{ core_time_slots['11:30'] }}</div>
                </div>
            </div>

            <!-- Core Events List -->
            {% if today_core_events %}
                <div class="core-events-list">
                    {% for schedule, event, employee in today_core_events %}
                    <div class="core-event-item">
                        <div class="core-event-time">{{ schedule.schedule_datetime.strftime('%I:%M %p') }}</div>
                        <div class="core-event-employee">{{ employee.name }}</div>
                        <div class="core-event-name" title="{{ event.project_name }}">{{ event.project_name }}</div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="no-items">No Core events scheduled for today</div>
            {% endif %}

            <!-- Print Schedule Buttons -->
            <div class="print-schedule-section">
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <label for="schedule-date" style="font-weight: bold;">Select Date:</label>
                    <input type="date" id="schedule-date" class="form-control" style="width: auto; min-width: 160px;" value="{{ today.strftime('%Y-%m-%d') }}">
                    <button onclick="printScheduleByDate()" class="btn btn-primary">
                        Print Schedule
                    </button>
                </div>
            </div>

            <!-- Print Paperwork Buttons -->
            <div class="print-schedule-section">
                <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                    <label for="paperwork-date" style="font-weight: bold;">Select Date:</label>
                    <input type="date" id="paperwork-date" class="form-control" style="width: auto; min-width: 160px;" value="{{ today_date }}">
                    <button onclick="printPaperworkByDate()" class="btn btn-success">
                        Print Paperwork
                    </button>
                    <button onclick="printSalesToolsByDate()" class="btn btn-primary">
                        Print SalesTools
                    </button>
                    <button onclick="generateEDRReports()" class="btn" style="background: var(--pc-navy); color: white;">
                        Generate EDR Reports
                    </button>
                </div>
            </div>
        </div>

        <!-- Unscheduled Events & Scheduling Progress -->
        <div class="dashboard-section">
            <div class="section-header">
                <h3 class="section-title">Scheduling Progress (Next 2 Weeks)</h3>
            </div>

            <!-- Scheduling Percentage -->
            <div class="percentage-display">
                <div class="percentage-number">{{ scheduling_percentage }}%</div>
                <div class="percentage-label">
                    {{ scheduled_events_2weeks }} of {{ total_events_2weeks }} events scheduled
                </div>
            </div>

            <!-- Unscheduled Events (within 2 weeks) -->
            <h4 style="margin: var(--spacing-md) 0 var(--spacing-sm) 0; color: var(--text-primary);">
                Urgent Unscheduled Events ({{ unscheduled_events_2weeks|length }})
            </h4>
            
            {% if unscheduled_events_2weeks %}
                <div class="unscheduled-list">
                    {% for event in unscheduled_events_2weeks %}
                    <div class="unscheduled-item">
                        <div class="unscheduled-header">
                            <div class="unscheduled-title">{{ event.project_name }}</div>
                            <span class="event-type-badge event-type-{{ event.event_type.lower() }}">
                                {{ event.event_type }}
                            </span>
                        </div>
                        <div class="unscheduled-dates">
                            📅 {{ event.start_datetime.strftime('%m/%d') }} - {{ event.due_datetime.strftime('%m/%d') }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                
                <div style="text-align: center; margin-top: var(--spacing-md);">
                    <a href="{{ url_for('main.unscheduled_events') }}" class="btn btn-outline">
                        View All Unscheduled Events
                    </a>
                </div>
            {% else %}
                <div class="no-items">All events within 2 weeks are scheduled!</div>
            {% endif %}
        </div>

        <!-- External API Sync Status -->
        <div class="dashboard-section" id="sync-status-section">
            <div class="section-header">
                <h3 class="section-title">External API Sync Status</h3>
                <button onclick="refreshSyncStatus()" class="btn btn-outline" style="font-size: 0.9em; padding: 0.5rem 1rem;">
                    Refresh Status
                </button>
            </div>

            <div id="sync-status-content">
                <div class="loading-indicator" style="text-align: center; padding: 2rem;">
                    Loading sync status...
                </div>
            </div>

            <div class="sync-actions" style="margin-top: var(--spacing-md); text-align: center;">
                <button onclick="triggerManualSync()" class="btn btn-primary" id="manual-sync-btn">
                    Manual Sync
                </button>
                <a href="{{ url_for('admin.sync_admin') }}" class="btn btn-outline">
                    Sync Settings
                </a>
            </div>
        </div>
    </div>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="flash-messages" style="margin-bottom: var(--spacing-lg);">
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- MFA Authentication Modal -->
    <div id="mfa-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 400px; width: 90%; box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);">
            <h3 style="margin: 0 0 1rem 0; color: var(--pc-navy);">EDR Authentication Required</h3>
            <p style="margin: 0 0 1.5rem 0; color: var(--text-secondary); font-size: 0.95rem;">
                Enter the MFA code sent to your phone to authenticate with Walmart Retail Link for EDR reports.
            </p>
            <div style="margin-bottom: 1.5rem;">
                <label for="mfa-code-input" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: var(--text-primary);">MFA Code</label>
                <input type="text"
                       id="mfa-code-input"
                       placeholder="Enter 6-digit code"
                       maxlength="6"
                       style="width: 100%; padding: 0.75rem; border: 2px solid var(--pc-light-blue); border-radius: 4px; font-size: 1.1rem; text-align: center; letter-spacing: 0.2em;">
            </div>
            <div id="mfa-error" style="display: none; padding: 0.75rem; background: #fee; color: #c33; border-radius: 4px; margin-bottom: 1rem; font-size: 0.9rem;"></div>
            <div style="display: flex; gap: 0.75rem;">
                <button onclick="cancelMFAAuth()" class="btn btn-secondary" style="flex: 1;">Cancel</button>
                <button onclick="submitMFACode()" id="mfa-submit-btn" class="btn btn-primary" style="flex: 1;">Authenticate</button>
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
// Print today's schedule functionality - matching calendar format exactly
function printTodaySchedule() {
    // Use explicit date formatting to avoid timezone issues
    const todayStr = '{{ today.strftime('%A, %B %d, %Y') }}';

    // Prepare events data for printing (Core and Juicer Production only)
    const printableEvents = [
        {% for schedule, event, employee in today_core_events %}
        {
            employee_name: "{{ employee.name }}",
            time: "{{ schedule.schedule_datetime.strftime('%I:%M %p') }}",
            event_name: "{{ event.project_name }}",
            event_type: "{{ event.event_type }}",
            minutes: convertTimeToMinutes("{{ schedule.schedule_datetime.strftime('%I:%M %p') }}")
        },
        {% endfor %}
    ];

    // Filter and sort events (same logic as calendar)
    const filteredEvents = printableEvents.filter(event => {
        return event.event_type === 'Core' || 
               (event.event_type === 'Juicer' && 
                event.event_name.includes('Production') && 
                !event.event_name.toLowerCase().includes('survey'));
    });

    // Sort by time
    filteredEvents.sort((a, b) => a.minutes - b.minutes);

    if (filteredEvents.length === 0) {
        alert('No Core or Juicer Production events found for this day.');
        return;
    }

    // Generate printable HTML with exact same format as calendar
    const printContent = generatePrintableSchedule(todayStr, filteredEvents);
    
    // Create and open print window
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
}

function printTomorrowSchedule() {
    // Use explicit date formatting to avoid timezone issues
    const tomorrowStr = '{{ tomorrow.strftime('%A, %B %d, %Y') }}';

    // Prepare tomorrow's events data (we'll need to get this from the backend)
    const printableEvents = [
        {% for schedule, event, employee in tomorrow_core_events %}
        {
            employee_name: "{{ employee.name }}",
            time: "{{ schedule.schedule_datetime.strftime('%I:%M %p') }}",
            event_name: "{{ event.project_name }}",
            event_type: "{{ event.event_type }}"
        },
        {% endfor %}
    ];

    // Filter for Core and Juicer Production events only
    const filteredEvents = printableEvents.filter(event =>
        event.event_type === 'Core' || event.event_type === 'Juicer'
    );

    const printContent = generatePrintableSchedule(tomorrowStr, filteredEvents);

    // Create and open print window
    const printWindow = window.open('', '_blank');
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.focus();
    printWindow.print();
}

// New function for date-based schedule printing
function printScheduleByDate() {
    const dateInput = document.getElementById('schedule-date');
    const selectedDate = dateInput.value;

    if (!selectedDate) {
        alert('Please select a date');
        return;
    }

    // Show loading indicator
    const statusDiv = document.createElement('div');
    statusDiv.id = 'schedule-loading-status';
    statusDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--pc-navy); color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 999;';
    statusDiv.textContent = 'Loading schedule...';
    document.body.appendChild(statusDiv);

    // Fetch schedule data for the selected date
    fetch(`/api/schedule/print/${selectedDate}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to fetch schedule data');
            }
            return response.json();
        })
        .then(data => {
            // Remove loading indicator
            document.body.removeChild(statusDiv);

            if (!data.events || data.events.length === 0) {
                alert('No Core or Juicer Production events found for this date.');
                return;
            }

            // Sort events by time
            data.events.sort((a, b) => a.minutes - b.minutes);

            // Generate printable HTML
            const printContent = generatePrintableSchedule(data.formatted_date, data.events);

            // Create and open print window
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        })
        .catch(error => {
            // Remove loading indicator if it exists
            const loadingDiv = document.getElementById('schedule-loading-status');
            if (loadingDiv) {
                document.body.removeChild(loadingDiv);
            }
            alert('Error loading schedule: ' + error.message);
            console.error('Error:', error);
        });
}

function convertTimeToMinutes(timeStr) {
    // Convert time like "9:15 AM" to minutes for sorting
    const [time, modifier] = timeStr.split(' ');
    const [hours, minutes] = time.split(':');
    let hour = parseInt(hours);
    
    if (modifier === 'PM' && hour !== 12) {
        hour += 12;
    } else if (modifier === 'AM' && hour === 12) {
        hour = 0;
    }
    
    return hour * 60 + parseInt(minutes);
}

function generatePrintableSchedule(dateStr, printableEvents) {
    return `
    <!DOCTYPE html>
    <html>
    <head>
        <title>Core Events Schedule - ${dateStr}</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 40px;
                background: white;
            }
            .header {
                text-align: center;
                margin-bottom: 30px;
                border-bottom: 3px solid #2E4C73;
                padding-bottom: 20px;
            }
            .date-title {
                font-size: 24px;
                font-weight: bold;
                color: #2E4C73;
                margin: 0;
            }
            .subtitle {
                font-size: 16px;
                color: #666;
                margin: 5px 0 0 0;
            }
            .schedule-table {
                width: 100%;
                border-collapse: collapse;
                margin-top: 20px;
            }
            .schedule-table th {
                background: #2E4C73;
                color: white;
                padding: 12px;
                text-align: left;
                font-weight: bold;
                font-size: 14px;
                border: 1px solid #ddd;
            }
            .schedule-table td {
                padding: 10px 12px;
                border: 1px solid #ddd;
                font-size: 13px;
            }
            .schedule-table tr:nth-child(even) {
                background-color: #f9f9f9;
            }
            .schedule-table tr:hover {
                background-color: #f0f0f0;
            }
            .employee-name {
                font-weight: bold;
                color: #2E4C73;
            }
            .event-time {
                font-weight: bold;
                color: #1B9BD8;
            }
            .event-name {
                color: #333;
            }
            .footer {
                margin-top: 40px;
                text-align: center;
                font-size: 12px;
                color: #888;
                border-top: 1px solid #ddd;
                padding-top: 20px;
            }
            @media print {
                body { margin: 20px; }
                .header { page-break-after: avoid; }
            }
        </style>
    </head>
    <body>
        <div class="header">
            <h1 class="date-title">${dateStr}</h1>
            <p class="subtitle">Daily Schedule</p>
        </div>
        
        <table class="schedule-table">
            <thead>
                <tr>
                    <th style="width: 30%;">Employee Name</th>
                    <th style="width: 20%;">Scheduled Time</th>
                    <th style="width: 50%;">Event Name</th>
                </tr>
            </thead>
            <tbody>
                ${printableEvents.map(event => `
                    <tr>
                        <td class="employee-name">${event.employee_name}</td>
                        <td class="event-time">${event.time}</td>
                        <td class="event-name">${event.event_name}</td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
        
        <div class="footer">
            <p>Generated on ${new Date().toLocaleString()} | Product Connections Scheduler</p>
        </div>
    </body>
    </html>
    `;
}

// Sync status management functions
function refreshSyncStatus() {
    const syncContent = document.getElementById('sync-status-content');
    syncContent.innerHTML = '<div class="loading-indicator" style="text-align: center; padding: 2rem;">Refreshing sync status...</div>';

    fetch('/api/sync/status')
        .then(response => response.json())
        .then(data => {
            renderSyncStatus(data);
        })
        .catch(error => {
            console.error('Failed to fetch sync status:', error);
            syncContent.innerHTML = `
                <div class="error-message" style="text-align: center; padding: 2rem; color: var(--color-error);">
                    Failed to load sync status: ${error.message}
                </div>
            `;
        });
}

function renderSyncStatus(data) {
    const syncContent = document.getElementById('sync-status-content');

    if (!data.sync_enabled) {
        syncContent.innerHTML = `
            <div class="sync-disabled-message" style="text-align: center; padding: 2rem; background: #f5f5f5; border-radius: 8px;">
                <h4 style="color: #666; margin: 0 0 1rem 0;">External API Sync is Disabled</h4>
                <p style="color: #888; margin: 0;">Configure SYNC_ENABLED=true in your environment to enable synchronization</p>
            </div>
        `;
        return;
    }

    const statusColor = (pending, failed) => {
        if (failed > 0) return '#e74c3c';
        if (pending > 0) return '#f39c12';
        return '#27ae60';
    };

    syncContent.innerHTML = `
        <div class="sync-status-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 1rem;">
            <div class="sync-stat-card" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                <h4 style="margin: 0 0 0.5rem 0; color: #2c3e50;">Employees</h4>
                <div style="font-size: 1.2rem; font-weight: bold; color: ${statusColor(data.employees.pending, data.employees.failed)};">
                    ${data.employees.synced} synced
                </div>
                <div style="font-size: 0.9rem; color: #666;">
                    ${data.employees.pending} pending, ${data.employees.failed} failed
                </div>
                ${data.employees.last_sync ? `<div style="font-size: 0.8rem; color: #999; margin-top: 0.5rem;">Last: ${formatSyncDate(data.employees.last_sync)}</div>` : ''}
            </div>

            <div class="sync-stat-card" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                <h4 style="margin: 0 0 0.5rem 0; color: #2c3e50;">Events</h4>
                <div style="font-size: 1.2rem; font-weight: bold; color: ${statusColor(data.events.pending, data.events.failed)};">
                    ${data.events.synced} synced
                </div>
                <div style="font-size: 0.9rem; color: #666;">
                    ${data.events.pending} pending, ${data.events.failed} failed
                </div>
                ${data.events.last_sync ? `<div style="font-size: 0.8rem; color: #999; margin-top: 0.5rem;">Last: ${formatSyncDate(data.events.last_sync)}</div>` : ''}
            </div>

            <div class="sync-stat-card" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; text-align: center;">
                <h4 style="margin: 0 0 0.5rem 0; color: #2c3e50;">Schedules</h4>
                <div style="font-size: 1.2rem; font-weight: bold; color: ${statusColor(data.schedules.pending, data.schedules.failed)};">
                    ${data.schedules.synced} synced
                </div>
                <div style="font-size: 0.9rem; color: #666;">
                    ${data.schedules.pending} pending, ${data.schedules.failed} failed
                </div>
                ${data.schedules.last_sync ? `<div style="font-size: 0.8rem; color: #999; margin-top: 0.5rem;">Last: ${formatSyncDate(data.schedules.last_sync)}</div>` : ''}
            </div>
        </div>

        <div id="api-health-status" style="margin-top: 1rem;">
            <div style="font-size: 0.9rem; color: #666; text-align: center;">
                Checking API connectivity...
            </div>
        </div>
    `;

    // Check API health
    fetch('/api/sync/health')
        .then(response => response.json())
        .then(healthData => {
            const healthDiv = document.getElementById('api-health-status');
            const status = healthData.external_api?.status || 'unknown';
            const statusColors = {
                'healthy': '#27ae60',
                'unhealthy': '#e74c3c',
                'disabled': '#95a5a6',
                'unknown': '#f39c12'
            };

            healthDiv.innerHTML = `
                <div style="text-align: center; padding: 0.5rem; background: ${statusColors[status]}15; border-radius: 4px; border-left: 4px solid ${statusColors[status]};">
                    <strong>API Status:</strong>
                    <span style="color: ${statusColors[status]}; text-transform: capitalize;">${status}</span>
                    ${healthData.external_api?.message ? ` - ${healthData.external_api.message}` : ''}
                </div>
            `;
        })
        .catch(() => {
            document.getElementById('api-health-status').innerHTML = `
                <div style="text-align: center; color: #e74c3c;">
                    Failed to check API health
                </div>
            `;
        });
}

function triggerManualSync() {
    const syncBtn = document.getElementById('manual-sync-btn');
    const originalText = syncBtn.textContent;

    syncBtn.disabled = true;
    syncBtn.textContent = 'Syncing...';

    fetch('/api/sync/trigger', { method: 'POST' })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success' || data.status === 'partial') {
                alert(`Sync completed: ${data.status}\n\nEmployees: ${data.employees?.synced || 0} synced, ${data.employees?.errors || 0} errors\nEvents: ${data.events?.synced || 0} synced, ${data.events?.errors || 0} errors\nSchedules: ${data.schedules?.synced || 0} synced, ${data.schedules?.errors || 0} errors`);
                refreshSyncStatus();
            } else {
                alert(`Sync failed: ${data.message || 'Unknown error'}`);
            }
        })
        .catch(error => {
            console.error('Sync failed:', error);
            alert(`Sync failed: ${error.message}`);
        })
        .finally(() => {
            syncBtn.disabled = false;
            syncBtn.textContent = originalText;
        });
}

function formatSyncDate(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);

    if (diffMins < 1) return 'Just now';
    if (diffMins < 60) return `${diffMins}m ago`;
    if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
    return date.toLocaleDateString();
}

// Global variable to track pending paperwork type
let pendingPaperworkType = null;
let pendingEDRDate = null;

// MFA Modal functions
function showMFAModal(paperworkType) {
    pendingPaperworkType = paperworkType;
    const modal = document.getElementById('mfa-modal');
    const input = document.getElementById('mfa-code-input');
    const error = document.getElementById('mfa-error');

    modal.style.display = 'flex';
    input.value = '';
    error.style.display = 'none';
    input.focus();
}

function cancelMFAAuth() {
    const modal = document.getElementById('mfa-modal');
    modal.style.display = 'none';
    pendingPaperworkType = null;
    pendingEDRDate = null;
}

function submitMFACode() {
    const input = document.getElementById('mfa-code-input');
    const error = document.getElementById('mfa-error');
    const submitBtn = document.getElementById('mfa-submit-btn');
    const mfaCode = input.value.trim();

    if (!mfaCode || mfaCode.length !== 6) {
        error.textContent = 'Please enter a 6-digit MFA code';
        error.style.display = 'block';
        return;
    }

    // Determine which workflow to use (paperwork or EDR)
    if (pendingEDRDate) {
        submitMFACodeForEDR(mfaCode, submitBtn, error);
    } else if (selectedPaperworkDate) {
        submitMFACodeForPaperwork(mfaCode, submitBtn, error);
    } else {
        error.textContent = 'No operation pending';
        error.style.display = 'block';
    }
}

function submitMFACodeForPaperwork(mfaCode, submitBtn, error) {
    // Disable button and show loading
    submitBtn.disabled = true;
    submitBtn.textContent = 'Generating Paperwork...';
    error.style.display = 'none';

    // Generate daily paperwork with MFA code
    fetch('/api/daily_paperwork/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mfa_code: mfaCode,
            date: selectedPaperworkDate
        })
    })
    .then(response => {
        if (response.ok) {
            // Close modal
            cancelMFAAuth();

            // Download the PDF
            return response.blob().then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Paperwork_${selectedPaperworkDate}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                // Show success message
                const successDiv = document.createElement('div');
                successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 999;';
                successDiv.textContent = 'Daily paperwork generated successfully!';
                document.body.appendChild(successDiv);
                setTimeout(() => document.body.removeChild(successDiv), 3000);

                selectedPaperworkDate = null;  // Reset after use
            });
        } else {
            return response.json().then(data => {
                throw new Error(data.error || 'Failed to generate paperwork');
            });
        }
    })
    .catch(err => {
        error.textContent = err.message || 'Unknown error occurred';
        error.style.display = 'block';
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Authenticate';
    });
}

function submitMFACodeForEDR(mfaCode, submitBtn, error) {
    // Disable button and show loading
    submitBtn.disabled = true;
    submitBtn.textContent = 'Generating EDR Reports...';
    error.style.display = 'none';

    // Generate EDR reports with MFA code
    fetch('/api/edr_reports/generate_by_date', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            mfa_code: mfaCode,
            date: pendingEDRDate
        })
    })
    .then(response => {
        if (response.ok) {
            // Close modal
            cancelMFAAuth();

            // Download the PDF
            return response.blob().then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `EDR_Reports_${pendingEDRDate}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);

                // Show success message
                const successDiv = document.createElement('div');
                successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 999;';
                successDiv.textContent = 'EDR reports generated successfully!';
                document.body.appendChild(successDiv);
                setTimeout(() => document.body.removeChild(successDiv), 3000);

                pendingEDRDate = null;  // Reset after use
            });
        } else {
            return response.json().then(data => {
                throw new Error(data.error || 'Failed to generate EDR reports');
            });
        }
    })
    .catch(err => {
        error.textContent = err.message || 'Unknown error occurred';
        error.style.display = 'block';
    })
    .finally(() => {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Authenticate';
    });
}

function generatePaperworkByDate(dateStr) {
    console.log('Generating paperwork for date:', dateStr);
    const statusDiv = document.createElement('div');
    statusDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--pc-navy); color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 999;';
    statusDiv.textContent = 'Generating comprehensive paperwork PDF...';
    document.body.appendChild(statusDiv);

    fetch(`/api/print_paperwork_by_date/${dateStr}`)
        .then(response => {
            console.log('Response received:', response.status, response.statusText);
            if (response.ok) {
                return response.blob();
            } else {
                return response.json().then(err => Promise.reject(err));
            }
        })
        .then(blob => {
            console.log('Blob received, size:', blob.size);
            // Create download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Sales_Tools_${dateStr}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            statusDiv.style.background = '#27ae60';
            statusDiv.textContent = 'PDF downloaded successfully!';
            setTimeout(() => document.body.removeChild(statusDiv), 3000);
        })
        .catch(error => {
            console.error('Error generating paperwork:', error);
            statusDiv.style.background = '#e74c3c';
            statusDiv.textContent = `Error: ${error.error || error.message || 'Unknown error'}`;
            setTimeout(() => document.body.removeChild(statusDiv), 5000);
        });
}

// Allow Enter key to submit MFA code
document.addEventListener('DOMContentLoaded', function() {
    const mfaInput = document.getElementById('mfa-code-input');
    if (mfaInput) {
        mfaInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                submitMFACode();
            }
        });
    }
});

// Global variable to store the selected date for paperwork
let selectedPaperworkDate = null;

// Paperwork printing functions
function printPaperworkByDate() {
    const dateInput = document.getElementById('paperwork-date');
    selectedPaperworkDate = dateInput.value;

    if (!selectedPaperworkDate) {
        alert('Please select a date');
        return;
    }

    // Request MFA code and show modal
    requestMFACodeAndShowModalForPaperwork();
}

// Print SalesTools for selected date
function printSalesToolsByDate() {
    const dateInput = document.getElementById('paperwork-date');
    const selectedDate = dateInput.value;

    if (!selectedDate) {
        alert('Please select a date');
        return;
    }

    // Show loading indicator
    const statusDiv = document.createElement('div');
    statusDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--pc-navy); color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 999;';
    statusDiv.textContent = 'Downloading and merging SalesTools PDFs...';
    document.body.appendChild(statusDiv);

    fetch(`/api/print_salestools_by_date/${selectedDate}`)
        .then(response => {
            if (response.ok) {
                return response.blob();
            } else {
                return response.json().then(err => {
                    throw new Error(err.error || 'Failed to generate SalesTools PDF');
                });
            }
        })
        .then(blob => {
            // Create download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `SalesTools_${selectedDate}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            // Update status
            statusDiv.style.background = '#27ae60';
            statusDiv.textContent = 'SalesTools PDF downloaded successfully!';
            setTimeout(() => document.body.removeChild(statusDiv), 3000);

            // Open print dialog
            const printWindow = window.open(url, '_blank');
            if (printWindow) {
                printWindow.onload = function() {
                    printWindow.print();
                };
            }
        })
        .catch(error => {
            console.error('Error generating SalesTools PDF:', error);
            statusDiv.style.background = '#e74c3c';
            statusDiv.textContent = `Error: ${error.message}`;
            setTimeout(() => document.body.removeChild(statusDiv), 5000);
        });
}

function requestMFACodeAndShowModalForPaperwork() {
    // Show loading indicator
    const statusDiv = document.createElement('div');
    statusDiv.id = 'mfa-request-status';
    statusDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--pc-navy); color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 999;';
    statusDiv.textContent = 'Requesting MFA code...';
    document.body.appendChild(statusDiv);

    // Request MFA code to be sent
    fetch('/api/daily_paperwork/request_mfa', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        // Remove loading indicator
        document.body.removeChild(statusDiv);

        if (data.success) {
            // Show success message briefly
            const successDiv = document.createElement('div');
            successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 999;';
            successDiv.textContent = 'MFA code sent to your phone!';
            document.body.appendChild(successDiv);

            setTimeout(() => {
                document.body.removeChild(successDiv);
                // Now show the MFA modal
                showMFAModalForPaperwork();
            }, 1500);
        } else {
            alert('Failed to request MFA code: ' + (data.error || data.message || 'Unknown error'));
        }
    })
    .catch(err => {
        // Remove loading indicator
        const loadingDiv = document.getElementById('mfa-request-status');
        if (loadingDiv) {
            document.body.removeChild(loadingDiv);
        }
        alert('Error requesting MFA code: ' + (err.message || 'Unknown error'));
    });
}

function showMFAModalForPaperwork() {
    const modal = document.getElementById('mfa-modal');
    const input = document.getElementById('mfa-code-input');
    const error = document.getElementById('mfa-error');

    modal.style.display = 'flex';
    input.value = '';
    error.style.display = 'none';
    input.focus();
}

// Legacy functions (kept for backward compatibility)
function printTodayPaperwork() {
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('paperwork-date').value = today;
    printPaperworkByDate();
}

function printTomorrowPaperwork() {
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    document.getElementById('paperwork-date').value = tomorrow.toISOString().split('T')[0];
    printPaperworkByDate();
}

function requestMFACodeAndShowModal(paperworkType) {
    // Show loading indicator
    const statusDiv = document.createElement('div');
    statusDiv.id = 'mfa-request-status';
    statusDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--pc-navy); color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 999;';
    statusDiv.textContent = 'Requesting MFA code...';
    document.body.appendChild(statusDiv);

    // Request MFA code to be sent
    fetch('/api/edr/request_code', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        // Remove loading indicator
        document.body.removeChild(statusDiv);

        if (data.success) {
            // Show success message briefly
            const successDiv = document.createElement('div');
            successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 999;';
            successDiv.textContent = 'MFA code sent to your phone!';
            document.body.appendChild(successDiv);

            setTimeout(() => {
                document.body.removeChild(successDiv);
                // Now show the MFA modal
                showMFAModal(paperworkType);
            }, 1500);
        } else {
            alert('Failed to request MFA code: ' + (data.message || 'Unknown error'));
        }
    })
    .catch(err => {
        // Remove loading indicator
        const loadingDiv = document.getElementById('mfa-request-status');
        if (loadingDiv) {
            document.body.removeChild(loadingDiv);
        }
        alert('Error requesting MFA code: ' + (err.message || 'Unknown error'));
    });
}

function generatePaperwork(type) {
    console.log('generatePaperwork called with type:', type);
    const statusDiv = document.createElement('div');
    statusDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--pc-navy); color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 999;';
    statusDiv.textContent = 'Generating PDF...';
    document.body.appendChild(statusDiv);
    console.log('Status div added to body');

    console.log('Fetching:', `/api/print_paperwork/${type}`);
    fetch(`/api/print_paperwork/${type}`)
        .then(response => {
            console.log('Response received:', response.status, response.statusText);
            if (response.ok) {
                return response.blob();
            } else {
                return response.json().then(err => Promise.reject(err));
            }
        })
        .then(blob => {
            console.log('Blob received, size:', blob.size);
            // Create download link
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const dateStr = type === 'today'
                ? new Date().toISOString().split('T')[0]
                : (() => { const d = new Date(); d.setDate(d.getDate() + 1); return d.toISOString().split('T')[0]; })();
            a.download = `Sales_Tools_${type}_${dateStr}.pdf`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);

            statusDiv.style.background = '#27ae60';
            statusDiv.textContent = 'PDF downloaded successfully!';
            setTimeout(() => document.body.removeChild(statusDiv), 3000);
        })
        .catch(error => {
            console.error('Error generating paperwork:', error);
            statusDiv.style.background = '#e74c3c';
            statusDiv.textContent = `Error: ${error.error || error.message || 'Unknown error'}`;
            setTimeout(() => document.body.removeChild(statusDiv), 5000);
        });
}

// Auto-scheduler functions
function checkPendingProposal() {
    fetch('{{ url_for("auto_scheduler.dashboard_status") }}')
        .then(response => response.json())
        .then(data => {
            const notification = document.getElementById('auto-scheduler-notification');
            if (data.has_pending) {
                notification.style.display = 'block';
            } else {
                notification.style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Failed to check pending proposals:', error);
        });
}

function runAutoScheduler() {
    const btn = document.getElementById('auto-schedule-btn');
    const statusSpan = document.getElementById('auto-schedule-status');

    btn.disabled = true;
    btn.textContent = 'Running...';
    statusSpan.textContent = 'Analyzing events...';

    fetch('{{ url_for("auto_scheduler.run_scheduler") }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            statusSpan.style.color = '#27ae60';
            statusSpan.textContent = `✓ Completed: ${data.stats.events_scheduled} scheduled, ${data.stats.events_requiring_swaps} swaps, ${data.stats.events_failed} failed`;

            // Update last run time
            const lastRunTime = document.getElementById('last-run-time');
            lastRunTime.textContent = 'Just now';

            // Check for pending proposals
            setTimeout(() => {
                checkPendingProposal();
            }, 500);

            // Show success message
            setTimeout(() => {
                if (data.stats.events_scheduled > 0 || data.stats.events_requiring_swaps > 0) {
                    if (confirm('Auto-scheduler completed successfully! Would you like to review the proposals now?')) {
                        window.location.href = '{{ url_for("auto_scheduler.review") }}';
                    }
                } else {
                    alert('Auto-scheduler completed but found no events to schedule in the next 3 weeks.');
                }
            }, 1000);
        } else {
            statusSpan.style.color = '#e74c3c';
            statusSpan.textContent = `Error: ${data.error}`;
            alert('Auto-scheduler failed: ' + data.error);
        }
    })
    .catch(error => {
        statusSpan.style.color = '#e74c3c';
        statusSpan.textContent = `Failed: ${error.message}`;
        alert('Failed to run auto-scheduler: ' + error.message);
    })
    .finally(() => {
        btn.disabled = false;
        btn.textContent = 'Run Auto-Scheduler';
    });
}

// EDR Reports generation function
function generateEDRReports() {
    const dateInput = document.getElementById('paperwork-date');
    const selectedDate = dateInput.value;

    if (!selectedDate) {
        alert('Please select a date');
        return;
    }

    // Store the date globally
    pendingEDRDate = selectedDate;

    // Request MFA code and show modal
    requestMFACodeForEDR();
}

function requestMFACodeForEDR() {
    // Show loading indicator
    const statusDiv = document.createElement('div');
    statusDiv.id = 'mfa-request-status-edr';
    statusDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: var(--pc-navy); color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 999;';
    statusDiv.textContent = 'Requesting MFA code for EDR reports...';
    document.body.appendChild(statusDiv);

    // Request MFA code to be sent
    fetch('/api/edr_reports/request_mfa', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        // Remove loading indicator
        document.body.removeChild(statusDiv);

        if (data.success) {
            // Show success message briefly
            const successDiv = document.createElement('div');
            successDiv.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 999;';
            successDiv.textContent = 'MFA code sent to your phone!';
            document.body.appendChild(successDiv);

            setTimeout(() => {
                document.body.removeChild(successDiv);
                // Now show the MFA modal
                showMFAModalForEDR();
            }, 1500);
        } else {
            alert('Failed to request MFA code: ' + (data.error || data.message || 'Unknown error'));
            pendingEDRDate = null;
        }
    })
    .catch(err => {
        // Remove loading indicator
        const loadingDiv = document.getElementById('mfa-request-status-edr');
        if (loadingDiv) {
            document.body.removeChild(loadingDiv);
        }
        alert('Error requesting MFA code: ' + (err.message || 'Unknown error'));
        pendingEDRDate = null;
    });
}

function showMFAModalForEDR() {
    const modal = document.getElementById('mfa-modal');
    const input = document.getElementById('mfa-code-input');
    const error = document.getElementById('mfa-error');

    modal.style.display = 'flex';
    input.value = '';
    error.style.display = 'none';
    input.focus();
}

// Load sync status and check for pending proposals on page load
document.addEventListener('DOMContentLoaded', function() {
    refreshSyncStatus();
    checkPendingProposal();
});
</script>
{% endblock %}