# Story 1.8: Per-Event Paperwork Printing

## Status
Ready for Review

## Story
**As a** scheduler,
**I want to** print paperwork for a single event,
**so that** I can reprint or preview documents without printing the entire daily batch.

## Acceptance Criteria
1. Each event on the Events page (both scheduled and unscheduled views) displays a "Print Event Paperwork" button in the action row
2. Clicking "Print Event Paperwork" opens a new window/tab with the generated PDF for that specific event
3. New route GET /api/print_event_paperwork/<int:event_id> accepts event ID and generates PDF containing exactly 4 pieces: EDR Report, Sales Tool PDF, Activity Log, and Checklist
4. The individual event PDF excludes schedule page and Daily Item Numbers page (unlike daily paperwork)
5. If event is not found or not scheduled, return 404 error with clear message
6. PDF filename includes event number for easy identification (e.g., "Event_12345_Paperwork.pdf")
7. Reuses existing PDF generation helpers (_download_and_add_pdf, _generate_edr_pdf) to avoid code duplication

## Tasks / Subtasks
- [ ] Task 1: Create print_event_paperwork route (AC: 3, 5, 6)
  - [ ] Add route @admin_bp.route('/api/print_event_paperwork/<int:event_id>') in routes/admin.py
  - [ ] Query Event, Schedule, Employee to get event details (project_name, sales_tools_url, location_mvid, employee_name)
  - [ ] Use joins: Event → Schedule → Employee
  - [ ] Filter by event_id parameter
  - [ ] Return 404 if event not found or not scheduled
  - [ ] Initialize PdfWriter for combining documents
  - [ ] Test route with valid event ID returns PDF
  - [ ] Test route with invalid event ID returns 404
- [ ] Task 2: Generate EDR Report for single event (AC: 3, 7)
  - [ ] Extract event number from project_name using existing extract_event_number() helper
  - [ ] Initialize EDR generator (same pattern as daily paperwork)
  - [ ] Check if EDR generator and auth_token are available
  - [ ] Call edr_generator.get_edr_report(event_number) to fetch EDR data
  - [ ] Generate HTML report with edr_generator.generate_html_report(edr_data, employee_name)
  - [ ] Convert HTML to PDF using xhtml2pdf (pisa.CreatePDF)
  - [ ] Add all EDR pages to PdfWriter
  - [ ] Handle errors gracefully: no event number, EDR auth failure, API errors (create placeholder page)
  - [ ] Test EDR generation for valid event with EDR data
- [ ] Task 3: Add Sales Tool PDF to combined output (AC: 3, 7)
  - [ ] Check if event.sales_tools_url exists
  - [ ] Download PDF from sales_tools_url using requests.get() (60s timeout)
  - [ ] Convert downloaded bytes to PdfReader
  - [ ] Add all Sales Tool pages to PdfWriter
  - [ ] Handle download errors gracefully (timeout, 404, invalid PDF)
  - [ ] Log download errors but continue processing
  - [ ] Test with valid sales_tools_url
  - [ ] Test with missing or invalid sales_tools_url
- [ ] Task 4: Add static Activity Log and Checklist PDFs (AC: 3)
  - [ ] Get base directory: os.path.dirname(os.path.dirname(__file__))
  - [ ] Load Activity Log: docs/Event Table Activity Log.pdf
  - [ ] Load Checklist: docs/Daily Task Checkoff Sheet.pdf
  - [ ] Add all Activity Log pages to PdfWriter
  - [ ] Add all Checklist pages to PdfWriter
  - [ ] Handle missing static files gracefully (log error, create placeholder)
  - [ ] Test static PDF inclusion
- [ ] Task 5: Return combined PDF with event-specific filename (AC: 6)
  - [ ] Write combined PDF to BytesIO buffer using pdf_writer.write(output)
  - [ ] Seek to beginning of buffer (output.seek(0))
  - [ ] Extract event number for filename
  - [ ] Return send_file(output, mimetype='application/pdf', as_attachment=True, download_name=f'Event_{event_number}_Paperwork.pdf')
  - [ ] Test PDF download with correct filename
- [ ] Task 6: Add "Print Event Paperwork" button to Events UI (AC: 1, 2)
  - [ ] Open templates/unscheduled.html (or wherever unscheduled events are displayed)
  - [ ] Locate event action row with existing buttons (Schedule, Edit, Delete)
  - [ ] Add new button: <button class="btn btn-sm btn-secondary" onclick="printEventPaperwork('{{ event.id }}')">Print Paperwork</button>
  - [ ] Add JavaScript function printEventPaperwork(eventId) that opens /api/print_event_paperwork/${eventId} in new window
  - [ ] Repeat for templates/scheduled.html (or scheduled events view)
  - [ ] Style button consistently with existing action buttons
  - [ ] Test button appears on both scheduled and unscheduled event lists
- [ ] Task 7: Extract reusable PDF helper functions (AC: 7)
  - [ ] Review existing daily paperwork code for common PDF operations
  - [ ] Extract _download_and_add_pdf(url) helper if not already exists
  - [ ] Extract _generate_edr_pdf(edr_generator, event_number, employee_name) helper if not already exists
  - [ ] Update both daily paperwork and per-event routes to use extracted helpers
  - [ ] Ensure no code duplication between routes
  - [ ] Test both routes work after refactoring
- [ ] Task 8: Testing implementation (AC: All)
  - [ ] Write integration tests for GET /api/print_event_paperwork/<event_id> with valid event
  - [ ] Write tests for 404 error when event not found
  - [ ] Write tests for 404 error when event not scheduled
  - [ ] Write tests for PDF structure contains 4 pieces (EDR, Sales Tool, Activity Log, Checklist)
  - [ ] Write tests for PDF excludes schedule page and item numbers page
  - [ ] Write tests for correct filename generation
  - [ ] Write tests for error handling (missing sales tool, EDR failure, missing static PDFs)
  - [ ] Manual testing: click "Print Event Paperwork" button and verify PDF content
  - [ ] Edge case testing: events with missing data, EDR auth failures, network errors

## Dev Notes

### Previous Story Insights
Story 1.7 successfully implemented Flexible Date-Based Printing with date picker UI and refactored PDF generation logic. Key patterns followed:
- Refactoring existing code into reusable helper functions
- Maintaining backward compatibility with existing routes
- Date validation and error handling
- Reusing existing PDF generation infrastructure (PyPDF2, xhtml2pdf, reportlab)
[Source: docs/stories/1.7.flexible-date-based-printing.md]

### Architecture Source for This Story
This story implements **Phase 2: Printing Enhancements** (Feature 2: Per-Event Paperwork Printing) from the Printing, Settings, and Analytics Enhancements architecture. This enables on-demand printing of individual event paperwork without generating the full daily batch.
[Source: docs/architecture/printing-settings-analytics-enhancements.md#feature-2-per-event-paperwork-printing]

### The "4 Pieces" for Individual Events

Individual event paperwork consists of exactly 4 documents:
1. **EDR Report** - Generated from Walmart Retail-Link API using event number
2. **Sales Tool PDF** - Downloaded from event.sales_tools_url
3. **Activity Log** - Static PDF: `docs/Event Table Activity Log.pdf`
4. **Checklist** - Static PDF: `docs/Daily Task Checkoff Sheet.pdf`

**Exclusions (vs Daily Paperwork):**
- ❌ Schedule page (not applicable for single event)
- ❌ Daily Item Numbers page (aggregation not needed for single event)

[Source: docs/architecture/printing-settings-analytics-enhancements.md#the-4-pieces-for-individual-events]

### Frontend Design Specifications

**Location:** Event action rows in both scheduled and unscheduled event views

**Current State:**
```html
Event Details | [Schedule] [Edit] [Delete]
```

**New State:**
```html
Event Details | [Schedule] [Edit] [Delete] [Print Event Paperwork]
```

**HTML Implementation:**
```html
<!-- Add to event action row -->
<button class="btn btn-sm btn-secondary"
        onclick="printEventPaperwork('{{ event.id }}')">
    <i class="icon-print"></i> Print Paperwork
</button>

<script>
function printEventPaperwork(eventId) {
    window.open(`/api/print_event_paperwork/${eventId}`, '_blank');
}
</script>
```

**Template Files to Update:**
- `scheduler_app/templates/unscheduled.html` (unscheduled events list)
- `scheduler_app/templates/scheduled.html` (scheduled events list)

[Source: docs/architecture/printing-settings-analytics-enhancements.md#frontend-changes-templatesunscheduledhtml-and-templatesscheduledhtml]

### Backend API Specifications

**New Route:** `GET /api/print_event_paperwork/<int:event_id>`
**Location:** `scheduler_app/routes/admin.py`

**Implementation Pattern:**
```python
@admin_bp.route('/api/print_event_paperwork/<int:event_id>')
def print_event_paperwork(event_id):
    """
    Print paperwork for a single event (4 pieces)
    Structure: EDR -> Sales Tool -> Activity Log -> Checklist
    (No schedule page, no item numbers aggregation)
    """
    db = current_app.extensions['sqlalchemy']
    Event = current_app.config['Event']
    Employee = current_app.config['Employee']
    Schedule = current_app.config['Schedule']

    # Get event and its schedule
    event_query = db.session.query(
        Event.project_name,
        Event.sales_tools_url,
        Event.location_mvid,
        Employee.name.label('employee_name')
    ).join(
        Schedule, Event.project_ref_num == Schedule.event_ref_num
    ).join(
        Employee, Schedule.employee_id == Employee.id
    ).filter(Event.id == event_id).first()

    if not event_query:
        return jsonify({'error': 'Event not found or not scheduled'}), 404

    # Initialize PDF writer
    pdf_writer = PdfWriter()

    # 1. Add EDR Report
    # 2. Add Sales Tool PDF
    # 3. Add Activity Log (static PDF)
    # 4. Add Checklist (static PDF)

    # Return combined PDF
    output = BytesIO()
    pdf_writer.write(output)
    output.seek(0)

    return send_file(
        output,
        mimetype='application/pdf',
        as_attachment=True,
        download_name=f'Event_{event_number}_Paperwork.pdf'
    )
```

[Source: docs/architecture/printing-settings-analytics-enhancements.md#backend-changes-routesadminpy-1]

### PDF Generation Helpers (Reusable)

**Helper 1: _initialize_edr_generator()**
- Initialize EDRGenerator with credentials from app.config (or SystemSetting in future)
- Try to restore session from Flask session cache
- Return edr_generator instance or None if initialization fails

**Helper 2: _generate_edr_pdf(edr_generator, event_number, employee_name)**
- Get EDR data using edr_generator.get_edr_report(event_number)
- Generate HTML report with edr_generator.generate_html_report(edr_data, employee_name)
- Convert HTML to PDF using xhtml2pdf (pisa.CreatePDF)
- Return PdfReader instance or None if generation fails

**Helper 3: _download_and_add_pdf(url)**
- Download PDF from URL using requests.get(url, timeout=60)
- Convert response bytes to PdfReader
- Return PdfReader instance or None if download/parse fails

**Helper 4: _create_placeholder_page(title, message)**
- Create simple placeholder PDF page using reportlab canvas
- Used when EDR/Sales Tool unavailable
- Return PdfReader with single placeholder page

These helpers should be extracted from existing daily paperwork code and reused in both routes.

[Source: docs/architecture/printing-settings-analytics-enhancements.md#key-design-decisions-1]

### Design Decisions

**Key Architectural Choices:**
1. ✅ **Reuse existing PDF generation helpers** - Extract common functions to avoid duplication
2. ✅ **Maintain same document order** - EDR → Sales Tool → Activity Log → Checklist (same as daily paperwork)
3. ✅ **Handle unscheduled events gracefully** - Return 404 error with clear message
4. ✅ **Event-specific filename** - Include event number for easy identification
5. ✅ **No database schema changes** - Uses existing Events, Schedules, Employees tables

[Source: docs/architecture/printing-settings-analytics-enhancements.md#key-design-decisions-1]

### File Locations

Based on current project structure:
- **Route Implementation:** `scheduler_app/routes/admin.py` (add new route)
- **Unscheduled Events Template:** `scheduler_app/templates/unscheduled.html` (add button)
- **Scheduled Events Template:** `scheduler_app/templates/scheduled.html` (add button)
- **EDR Generator:** `scheduler_app/services/edr_generator.py` (no changes needed)
- **Static PDFs:** `scheduler_app/docs/Event Table Activity Log.pdf` and `scheduler_app/docs/Daily Task Checkoff Sheet.pdf` (no changes)
- **Tests:** `scheduler_app/test_routes.py` (add new TestPerEventPaperwork class)

[Source: docs/brownfield-architecture.md#source-tree-and-module-organization]

### Integration Points

**EDR Generator Integration:**
- Location: `scheduler_app/services/edr_generator.py`
- Same authentication flow as daily paperwork
- EDR credentials use app.config (or SystemSetting if Story 1.6 completed)
- Session caching reduces API calls

**PDF Utilities:**
- PyPDF2 (PdfReader, PdfWriter) - PDF manipulation and merging
- reportlab - PDF canvas creation for placeholders/errors
- xhtml2pdf (pisa) - HTML to PDF conversion for EDR reports
- requests - Download Sales Tool PDFs from URLs

**Database Queries:**
- Joins Events → Schedules → Employees
- Filter by event_id to get single event details
- No aggregation needed (unlike daily paperwork)

[Source: docs/architecture/printing-settings-analytics-enhancements.md#integration-points-1]

### Technology Stack

**Backend:**
- Flask 3.0.0 - Web framework
- SQLAlchemy 2.0.36 - ORM for database queries
- PyPDF2 >=3.0.0 - PDF manipulation (already exists)
- reportlab >=4.0.0 - PDF generation (already exists)
- xhtml2pdf >=0.2.11 - HTML to PDF conversion (already exists)
- requests - HTTP client for downloading Sales Tool PDFs (already exists)
- SQLite - Database (existing)

**Frontend:**
- Jinja2 - Template engine (existing)
- Vanilla JavaScript ES6+ - Button click handler
- Custom CSS - Button styling (existing design system)

**Testing:**
- pytest 7.4.3 - Test framework (existing)
- Flask test client - Integration testing (existing patterns)

[Source: docs/brownfield-architecture.md#actual-tech-stack-production-ready]

### Security Considerations

**Input Validation:**
- Validate event_id is integer (Flask route converter handles this)
- Check event exists and is scheduled before processing
- Return 404 for invalid/unauthorized access attempts

**Access Control:**
- Route likely requires authentication (@require_authentication decorator)
- Only authorized users should access event paperwork
- No authorization bypass through direct event_id manipulation

**Error Handling:**
- Don't expose sensitive system information in error messages
- Log errors for debugging but show user-friendly messages
- Handle EDR authentication failures gracefully
- Handle network errors for Sales Tool downloads gracefully

[Source: docs/architecture/printing-settings-analytics-enhancements.md#security-considerations]

### Performance Considerations

**PDF Generation:**
- Single event paperwork is much faster than daily batch (fewer documents)
- EDR session caching reduces authentication overhead
- Sales Tool download is network-dependent (60s timeout)
- No performance-critical paths

**Database Queries:**
- Single event query with joins (very fast)
- No aggregation or complex calculations
- Query returns at most 1 row

[Source: docs/architecture/printing-settings-analytics-enhancements.md#performance-considerations]

### Error Handling Patterns

**Event Not Found:**
```python
if not event_query:
    return jsonify({'error': 'Event not found or not scheduled'}), 404
```

**EDR Generation Failure:**
- Create placeholder page with error message
- Log error for debugging
- Continue processing remaining documents

**Sales Tool Download Failure:**
- Log error for debugging
- Continue processing remaining documents
- Don't fail entire PDF generation

**Static PDF Missing:**
- Log critical error
- Create placeholder page
- Don't fail entire PDF generation

[Source: docs/architecture/printing-settings-analytics-enhancements.md#backend-changes-routesadminpy-1]

## Testing

### Testing Framework
- **Framework:** pytest 7.4.3
- **Test File:** `scheduler_app/test_routes.py`
- **Test Class:** Create new `TestPerEventPaperwork` class

### Test Categories

**1. Route Tests (print_event_paperwork)**
- Test GET /api/print_event_paperwork/1 returns 200 and PDF for valid event
- Test GET /api/print_event_paperwork/999999 returns 404 for non-existent event
- Test route returns 404 for unscheduled event
- Test route returns PDF with correct filename (Event_{number}_Paperwork.pdf)
- Test route requires authentication (if @require_authentication decorator exists)

**2. PDF Structure Tests**
- Test PDF contains exactly 4 pieces: EDR, Sales Tool, Activity Log, Checklist
- Test PDF does NOT contain schedule page
- Test PDF does NOT contain Daily Item Numbers page
- Test PDF page count is correct (varies by event data)
- Test PDF can be opened and read by PdfReader

**3. EDR Generation Tests**
- Test EDR report is included when event number exists and EDR auth succeeds
- Test placeholder page created when EDR auth fails
- Test placeholder page created when event has no event number
- Test EDR HTML report includes employee name

**4. Sales Tool Tests**
- Test Sales Tool PDF is included when sales_tools_url exists and download succeeds
- Test handling of missing sales_tools_url (skip or placeholder)
- Test handling of invalid sales_tools_url (404, timeout)
- Test handling of non-PDF response from sales_tools_url

**5. Static PDF Tests**
- Test Activity Log PDF is included from docs/Event Table Activity Log.pdf
- Test Checklist PDF is included from docs/Daily Task Checkoff Sheet.pdf
- Test handling of missing static PDFs (error logging, placeholder)

**6. Frontend Integration Tests**
- Test "Print Event Paperwork" button appears on unscheduled events page
- Test "Print Event Paperwork" button appears on scheduled events page
- Test clicking button calls printEventPaperwork(eventId) JavaScript function
- Test JavaScript function opens correct URL in new window

**7. Edge Cases**
- Test event with all documents available (full PDF)
- Test event with missing EDR data (placeholder for EDR only)
- Test event with missing Sales Tool (skip or placeholder for Sales Tool only)
- Test event with all documents missing (placeholder pages only)
- Test concurrent requests to print_event_paperwork

### Test Execution
- Run: `pytest scheduler_app/test_routes.py::TestPerEventPaperwork -v`
- Ensure all tests pass before marking story complete
- Verify test coverage for all acceptance criteria
- Follow existing test patterns from previous stories

[Source: docs/brownfield-architecture.md#testing-architecture, docs/architecture/printing-settings-analytics-enhancements.md#testing-strategy]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-02 | 1.0 | Initial story creation for per-event paperwork printing | Bob (Scrum Master) |
| 2025-10-02 | 1.1 | QA Fix: Added comprehensive test suite (10 tests) to address test coverage gap | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
- Test run: `pytest scheduler_app/test_per_event_paperwork.py -v` - 10/10 tests passed
- QA fix applied: 2025-10-02 - Added comprehensive test suite to address missing test coverage

### Completion Notes List
- QA Fix: Created comprehensive test suite with 10 tests covering all acceptance criteria
- Tests validate route authentication, PDF generation, error handling, and edge cases
- All tests passing - route tested for valid events, 404 errors, and graceful error handling

### File List
**New Files:**
- scheduler_app/test_per_event_paperwork.py - Comprehensive test suite (10 tests)

## QA Results

### Review Date: 2025-10-02
### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
**Overall**: Well-implemented feature that properly reuses existing PDF generation helpers. Clean code with good error handling.

**Strengths**:
- Reuses existing helpers (_download_and_add_pdf, EDR generation) avoiding code duplication
- Good error handling for missing events, failed downloads, EDR API failures
- Clear 404 responses for not found events
- Filename includes event number for easy identification
- Button placement in UI is intuitive

**Issues**:
- NO TESTS WRITTEN despite story requirements

### Compliance Check
- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✗ No tests
- All ACs Met: ✓ All 7 ACs implemented

### Gate Status
**Gate: CONCERNS** → docs/qa/gates/1.8-per-event-paperwork-printing.yml
**Quality Score: 80/100**
Feature is functional but needs test coverage.

### Recommended Status
**⚠️ Functional but Needs Tests** - Feature works, tests can be added later if team accepts.

**Requirements Traceability**: 7/7 ACs implemented, 0/7 tested
