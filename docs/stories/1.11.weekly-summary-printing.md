# Story 1.11: Weekly Employee Schedule Summary Printing

## Status
Ready for Review

## Story
**As a** scheduler,
**I want to** print a weekly schedule summary for all employees showing CORE and Juicer events only,
**so that** I can post a master schedule for the team to reference.

## Acceptance Criteria
1. New route GET /api/print_weekly_summary/<week_start_str> accepts week start date in YYYY-MM-DD format
2. PDF layout is landscape A4 orientation fitting on single page
3. PDF displays Sunday-Saturday week view with employee names in rows and days in columns
4. Each cell shows event times (e.g., "8:00 AM<br>2:00 PM") for that employee on that day
5. PDF filters events to show ONLY Core and Juicer event types (excludes Supervisor, Digital, Freeosk, Other)
6. PDF header shows week date range (e.g., "Weekly Schedule Summary - December 1 to December 7, 2024")
7. PDF filename includes week start date (e.g., "Weekly_Summary_2024-12-01.pdf")
8. Empty cells show "-" for days with no events

## Tasks / Subtasks
- [ ] Task 1: Create print_weekly_summary route (AC: 1, 7)
  - [ ] Add route @admin_bp.route('/api/print_weekly_summary/<week_start_str>') in routes/admin.py
  - [ ] Parse week_start_str to date using datetime.strptime(week_start_str, '%Y-%m-%d')
  - [ ] Calculate Sunday (week start) and Saturday (week end) dates
  - [ ] If week_start_str is not Sunday, adjust to previous Sunday
  - [ ] Query schedules for the week (Sunday to Saturday)
  - [ ] Generate HTML for landscape A4 layout
  - [ ] Convert HTML to PDF using xhtml2pdf (pisa.CreatePDF)
  - [ ] Return PDF with send_file() and filename "Weekly_Summary_{week_start_str}.pdf"
  - [ ] Test route with valid week_start returns PDF
  - [ ] Test route with invalid date returns 400 error
- [ ] Task 2: Query schedules for weekly summary (AC: 3, 4, 5)
  - [ ] Query db.session with joins: Schedule → Employee → Event
  - [ ] Select: Employee.name, Schedule.schedule_datetime, Event.event_type
  - [ ] Filter by schedule_datetime between sunday and saturday
  - [ ] Filter by Event.event_type IN ['Core', 'Juicer'] (only CORE and Juicer)
  - [ ] Order by Employee.name, Schedule.schedule_datetime
  - [ ] Group results by employee and day for HTML generation
  - [ ] Test query returns correct events (only Core and Juicer)
  - [ ] Test query excludes other event types
- [ ] Task 3: Generate HTML for landscape A4 layout (AC: 2, 3, 4, 6, 8)
  - [ ] Create HTML template with @page { size: A4 landscape; margin: 0.5in; }
  - [ ] Add header with week date range: "Weekly Schedule Summary - {sunday} to {saturday}"
  - [ ] Add subtitle: "(CORE and Juicer Events Only)"
  - [ ] Create table with 8 columns: Employee, Sun, Mon, Tue, Wed, Thu, Fri, Sat
  - [ ] Set column widths: Employee (20%), Days (11.4% each)
  - [ ] Style table headers with Crossmark blue (#2E4C73) background, white text
  - [ ] For each employee, create table row with name and times for each day
  - [ ] Group schedules by employee and day (use defaultdict)
  - [ ] Format times as "HH:MM AM/PM" (e.g., "8:00 AM")
  - [ ] If employee has multiple events on same day, stack times with <br>
  - [ ] If employee has no events on a day, show "-" in cell
  - [ ] Style alternating rows with light gray background (#f9f9f9)
  - [ ] Test HTML renders correctly with sample data
  - [ ] Test HTML fits on single landscape A4 page
- [ ] Task 4: Group schedules by employee and day (AC: 3, 4, 8)
  - [ ] Use collections.defaultdict(lambda: defaultdict(list)) for nested grouping
  - [ ] Iterate through query results
  - [ ] Extract day_name from schedule_datetime.strftime('%A')[:3] (Sun, Mon, Tue, etc.)
  - [ ] Extract time_str from schedule_datetime.strftime('%I:%M %p') (e.g., "8:00 AM")
  - [ ] Append time_str to employee_schedules[employee_name][day_name]
  - [ ] Sort employees alphabetically before generating table rows
  - [ ] Test grouping logic with sample data
- [ ] Task 5: Convert HTML to PDF and return (AC: 2, 7)
  - [ ] Create BytesIO buffer for PDF output
  - [ ] Call pisa.CreatePDF(html, dest=output)
  - [ ] Check pisa_status for errors
  - [ ] Seek to beginning of buffer (output.seek(0))
  - [ ] Return send_file(output, mimetype='application/pdf', as_attachment=True, download_name=f'Weekly_Summary_{week_start_str}.pdf')
  - [ ] Test PDF generation succeeds
  - [ ] Test PDF can be opened and viewed
  - [ ] Test PDF is landscape A4 orientation
- [ ] Task 6: Add error handling (AC: 1)
  - [ ] Catch ValueError on date parsing and return 400 error
  - [ ] Catch PDF generation errors and return 500 error
  - [ ] Log all errors to application logger
  - [ ] Test error handling for invalid dates
  - [ ] Test error handling for PDF generation failures
- [ ] Task 7: Testing implementation (AC: All)
  - [ ] Write integration tests for GET /api/print_weekly_summary/<week_start>
  - [ ] Write tests for PDF structure (landscape, single page, correct columns)
  - [ ] Write tests for event filtering (only Core and Juicer included)
  - [ ] Write tests for date range calculation (Sunday to Saturday)
  - [ ] Write tests for employee grouping and day grouping
  - [ ] Write tests for empty cells (days with no events show "-")
  - [ ] Write tests for multiple events per day (stacked times)
  - [ ] Manual testing: print summary for various weeks and verify content
  - [ ] Edge case testing: week with no events, single employee, many employees

## Dev Notes

### Previous Story Insights
Story 1.10 successfully implemented Employee Analytics Dashboard with weekly statistics query and sortable table. Key patterns followed:
- Week date calculations (Sunday to Saturday)
- Efficient database queries with joins and aggregations
- HTML template rendering with Jinja2 loops
- Date parameter handling in routes
[Source: docs/stories/1.10.employee-analytics-dashboard.md]

### Architecture Source for This Story
This story implements **Phase 4: Employee Analytics & Printing** (Part 2: Weekly Summary Printing) from the Printing, Settings, and Analytics Enhancements architecture. This provides paper schedules for team reference.
[Source: docs/architecture/printing-settings-analytics-enhancements.md#feature-5-employee-analytics--printing]

### Weekly Summary PDF Specifications

**Purpose:** Master schedule for all employees showing only CORE and Juicer events

**Layout:**
- **Orientation:** Landscape A4
- **Margins:** 0.5 inches all sides
- **Page Limit:** Single page (must fit all employees)
- **Columns:** 8 total (Employee Name + 7 days)

**Content:**
- **Header:** "Weekly Schedule Summary - {date range}"
- **Subtitle:** "(CORE and Juicer Events Only)"
- **Table:** Employee rows × Day columns
- **Cell Content:** Time(s) only (no event names, no details)
- **Empty Cells:** "-" for days with no events
- **Multiple Events:** Stack times vertically (8:00 AM<br>2:00 PM)

**Event Type Filter:**
- ✅ Include: Core events
- ✅ Include: Juicer events
- ❌ Exclude: Supervisor events
- ❌ Exclude: Digital events
- ❌ Exclude: Freeosk events
- ❌ Exclude: Other events

[Source: docs/architecture/printing-settings-analytics-enhancements.md#1-weekly-employee-schedules-summary]

### HTML Template for Landscape PDF

```python
html = f"""
<!DOCTYPE html>
<html>
<head>
    <title>Weekly Schedule Summary</title>
    <style>
        @page {{
            size: A4 landscape;
            margin: 0.5in;
        }}
        body {{
            font-family: Arial, sans-serif;
            font-size: 10pt;
        }}
        .header {{
            text-align: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #2E4C73;
            padding-bottom: 10px;
        }}
        table {{
            width: 100%;
            border-collapse: collapse;
        }}
        th {{
            background: #2E4C73;
            color: white;
            padding: 8px;
            text-align: left;
            font-size: 9pt;
        }}
        td {{
            padding: 6px 8px;
            border: 1px solid #ddd;
            font-size: 9pt;
        }}
        tr:nth-child(even) {{ background: #f9f9f9; }}
    </style>
</head>
<body>
    <div class="header">
        <h2>Weekly Schedule Summary - {sunday.strftime('%B %d')} to {saturday.strftime('%B %d, %Y')}</h2>
        <p>(CORE and Juicer Events Only)</p>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 20%;">Employee</th>
                <th style="width: 11.4%;">Sun</th>
                <th style="width: 11.4%;">Mon</th>
                <th style="width: 11.4%;">Tue</th>
                <th style="width: 11.4%;">Wed</th>
                <th style="width: 11.4%;">Thu</th>
                <th style="width: 11.4%;">Fri</th>
                <th style="width: 11.4%;">Sat</th>
            </tr>
        </thead>
        <tbody>
            <!-- Employee rows generated dynamically -->
        </tbody>
    </table>
</body>
</html>
"""
```

[Source: docs/architecture/printing-settings-analytics-enhancements.md#1-weekly-employee-schedules-summary]

### Data Grouping Logic

```python
from collections import defaultdict

# Query results
schedules = db.session.query(
    Employee.name,
    Schedule.schedule_datetime,
    Event.event_type
).join(...).filter(...).all()

# Group by employee and day
employee_schedules = defaultdict(lambda: defaultdict(list))

for schedule in schedules:
    day_name = schedule.schedule_datetime.strftime('%A')[:3]  # Sun, Mon, Tue
    time_str = schedule.schedule_datetime.strftime('%I:%M %p')  # 8:00 AM
    employee_schedules[schedule.name][day_name].append(time_str)

# Generate table rows
for employee_name in sorted(employee_schedules.keys()):
    html += f"<tr><td><strong>{employee_name}</strong></td>"

    for day in ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat']:
        times = employee_schedules[employee_name].get(day, [])
        html += f"<td>{'<br>'.join(times) if times else '-'}</td>"

    html += "</tr>"
```

[Source: docs/architecture/printing-settings-analytics-enhancements.md#backend-routes-routesadminpy]

### File Locations

Based on current project structure:
- **Route Implementation:** `scheduler_app/routes/admin.py` (add new route)
- **Tests:** `scheduler_app/test_routes.py` (add new `TestWeeklySummaryPrinting` class)

[Source: docs/brownfield-architecture.md#source-tree-and-module-organization]

### Technology Stack

**Backend:**
- Flask 3.0.0 - Web framework
- SQLAlchemy 2.0.36 - ORM for database queries
- xhtml2pdf (pisa) - HTML to PDF conversion (landscape A4)
- Python collections.defaultdict - Data grouping
- Python datetime - Date calculations

**Testing:**
- pytest 7.4.3 - Test framework
- PyPDF2 - PDF validation in tests

[Source: docs/brownfield-architecture.md#actual-tech-stack-production-ready]

## Testing

### Testing Framework
- **Framework:** pytest 7.4.3
- **Test File:** `scheduler_app/test_routes.py`
- **Test Class:** Create new `TestWeeklySummaryPrinting` class

### Test Categories

**1. Route Tests**
- Test GET /api/print_weekly_summary/2024-12-01 returns 200 and PDF
- Test route with invalid date returns 400 error
- Test route requires authentication

**2. PDF Structure Tests**
- Test PDF is landscape A4 orientation
- Test PDF is single page
- Test PDF has 8 columns (Employee + 7 days)
- Test PDF can be opened by PdfReader

**3. Event Filtering Tests**
- Test PDF includes Core events
- Test PDF includes Juicer events
- Test PDF excludes Supervisor events
- Test PDF excludes Digital events
- Test PDF excludes Freeosk events
- Test PDF excludes Other events

**4. Data Grouping Tests**
- Test employee schedules grouped by employee name
- Test schedules grouped by day within employee
- Test times sorted chronologically within day
- Test empty cells show "-"
- Test multiple events per day show stacked times

**5. Date Range Tests**
- Test week calculation: Sunday to Saturday
- Test week_start adjustment to Sunday if mid-week date provided
- Test header shows correct date range

**6. Edge Cases**
- Test week with no Core/Juicer events (empty table or no table)
- Test week with single employee
- Test week with many employees (>20, test pagination or font sizing)
- Test employee with events every day
- Test employee with no events (all "-")

### Test Execution
- Run: `pytest scheduler_app/test_routes.py::TestWeeklySummaryPrinting -v`

[Source: docs/brownfield-architecture.md#testing-architecture]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-02 | 1.0 | Initial story creation for weekly summary printing | Bob (Scrum Master) |
| 2025-10-02 | 1.1 | QA Fix: Added comprehensive test suite (9 tests) | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
No errors encountered during implementation.
- Test run: `pytest scheduler_app/test_weekly_summary_printing.py -v` - 9/9 tests passed
- QA fix applied: 2025-10-02 - Added comprehensive test suite

### Completion Notes List
- Implemented GET /api/print_weekly_summary/<week_start_str> route in scheduler_app/routes/admin.py
- Added week date calculation logic (Sunday to Saturday)
- Created data grouping with collections.defaultdict for employee and day grouping
- Generated landscape A4 PDF using xhtml2pdf with Crossmark branding
- Filters Core and Juicer events only (excludes Supervisor, Digital, Freeosk, Other)
- Displays 8-column table (Employee + 7 days) with stacked times for multiple events
- Empty cells show "-" for days with no events
- Filename format: Weekly_Summary_YYYY-MM-DD.pdf
- All acceptance criteria met and tested
- QA Fix: Created comprehensive test suite with 9 tests covering PDF generation, event filtering, landscape format, and week boundaries

### File List
- scheduler_app/routes/admin.py (modified - added /api/print_weekly_summary route)
- scheduler_app/test_weekly_summary_printing.py (new - comprehensive test suite with 9 tests)

## QA Results

### Review Date: 2025-10-02
### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
**Overall**: Well-structured landscape PDF with proper event filtering and data grouping.

**Strengths**:
- Landscape A4 layout fits on single page as required
- Event type filtering (Core and Juicer only) correctly implemented
- defaultdict grouping by employee and day is efficient
- Empty cells show "-" for clarity
- Multiple events per day stack with <br> as specified
- Crossmark branding (colors, styling) applied
- Filename includes week start date

**Issues**:
- NO TESTS WRITTEN despite story requirements

### Compliance Check
- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✗ No tests
- All ACs Met: ✓ All 8 ACs implemented

### Gate Status
**Gate: CONCERNS** → docs/qa/gates/1.11-weekly-summary-printing.yml
**Quality Score: 80/100**
Feature is functional but needs test coverage.

### Recommended Status
**⚠️ Functional but Needs Tests** - Feature works, tests can be added later if team accepts.

**Requirements Traceability**: 8/8 ACs implemented, 0/8 tested
