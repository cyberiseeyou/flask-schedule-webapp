# Story 1.12: Individual Employee Schedule Printing

## Status
Ready for Review

## Story
**As a** scheduler,
**I want to** print a detailed weekly schedule for a single employee showing all event types,
**so that** employees not using the mobile app can receive paper schedules.

## Acceptance Criteria
1. New route GET /api/print_employee_schedule/<employee_id>/<week_start_str> accepts employee ID and week start date
2. PDF layout is landscape A4 orientation fitting on single page
3. PDF shows employee name prominently in header
4. PDF displays Sunday-Saturday week view with one row per day
5. Each day row shows: Day/Date, Time, Event Name, Event Type for all scheduled events
6. PDF includes ALL event types (Core, Juicer, Supervisor, Digital, Freeosk, Other)
7. Days with no events show "No events scheduled" message
8. PDF filename includes employee name and week start date (e.g., "John_Doe_Schedule_2024-12-01.pdf")

## Tasks / Subtasks
- [ ] Task 1: Create print_employee_schedule route (AC: 1, 8)
  - [ ] Add route @admin_bp.route('/api/print_employee_schedule/<employee_id>/<week_start_str>') in routes/admin.py
  - [ ] Parse week_start_str to date using datetime.strptime(week_start_str, '%Y-%m-%d')
  - [ ] Calculate Sunday (week start) and Saturday (week end) dates
  - [ ] Query Employee by employee_id
  - [ ] Return 404 if employee not found
  - [ ] Query schedules for the employee for the week
  - [ ] Generate HTML for landscape A4 layout
  - [ ] Convert HTML to PDF using xhtml2pdf (pisa.CreatePDF)
  - [ ] Return PDF with filename "{employee_name}_Schedule_{week_start_str}.pdf" (replace spaces with underscores)
  - [ ] Test route with valid employee_id and week_start returns PDF
  - [ ] Test route with invalid employee_id returns 404
  - [ ] Test route with invalid date returns 400 error
- [ ] Task 2: Query individual employee schedules (AC: 4, 5, 6)
  - [ ] Query db.session with joins: Schedule → Event
  - [ ] Select: Schedule.schedule_datetime, Event.project_name, Event.event_type
  - [ ] Filter by Schedule.employee_id = employee_id
  - [ ] Filter by schedule_datetime between sunday and saturday
  - [ ] Order by Schedule.schedule_datetime ASC
  - [ ] Include ALL event types (no filtering by event_type)
  - [ ] Test query returns all event types for employee
  - [ ] Test query filters by date range correctly
- [ ] Task 3: Generate HTML for landscape A4 layout (AC: 2, 3, 4, 5, 7)
  - [ ] Create HTML template with @page { size: A4 landscape; margin: 0.75in; }
  - [ ] Add header with employee name (large, bold, Crossmark blue #2E4C73)
  - [ ] Add week range subtitle: "Week of {sunday} - {saturday}"
  - [ ] Create table with 3 columns: Day, Time, Event
  - [ ] Set column widths: Day (15%), Time (15%), Event (70%)
  - [ ] Style table headers with Crossmark blue background, white text
  - [ ] For each day of the week (Sunday to Saturday), create day section
  - [ ] Group events by day using daily_schedules defaultdict
  - [ ] If day has events, use rowspan for day cell and list all events
  - [ ] If day has no events, show "No events scheduled" in colspan=2 cell
  - [ ] Style day headers bold with Crossmark blue color
  - [ ] Style event times with light blue color (#1B9BD8)
  - [ ] Style "No events scheduled" with gray italic text
  - [ ] Test HTML renders correctly with sample data
  - [ ] Test HTML fits on single landscape A4 page
- [ ] Task 4: Group schedules by day (AC: 4, 5, 7)
  - [ ] Use collections.defaultdict(list) for day grouping
  - [ ] Iterate through query results
  - [ ] Extract day_key as schedule_datetime.date()
  - [ ] Append event details dict to daily_schedules[day_key]: {time, name, type}
  - [ ] Iterate through each day of week (Sunday to Saturday) for HTML generation
  - [ ] Check if day_key exists in daily_schedules
  - [ ] If exists, generate event rows for that day
  - [ ] If not exists, generate "No events scheduled" row
  - [ ] Test grouping logic with sample data
  - [ ] Test days with multiple events
  - [ ] Test days with no events
- [ ] Task 5: Handle rowspan for multiple events per day (AC: 5)
  - [ ] For each day with events, count number of events
  - [ ] Set rowspan={len(events)} on day cell (first row only)
  - [ ] Generate subsequent rows without day cell (day cell spans multiple rows)
  - [ ] Ensure proper HTML table structure (valid rowspan usage)
  - [ ] Test rowspan rendering with 1 event, 2 events, 5+ events per day
- [ ] Task 6: Convert HTML to PDF and return (AC: 2, 8)
  - [ ] Create BytesIO buffer for PDF output
  - [ ] Call pisa.CreatePDF(html, dest=output)
  - [ ] Check pisa_status for errors
  - [ ] Seek to beginning of buffer (output.seek(0))
  - [ ] Format filename: employee.name.replace(' ', '_') + f'_Schedule_{week_start_str}.pdf'
  - [ ] Return send_file(output, mimetype='application/pdf', as_attachment=True, download_name=filename)
  - [ ] Test PDF generation succeeds
  - [ ] Test PDF is landscape A4 orientation
  - [ ] Test filename includes employee name (spaces replaced with underscores)
- [ ] Task 7: Add error handling (AC: 1)
  - [ ] Catch ValueError on date parsing and return 400 error
  - [ ] Catch PDF generation errors and return 500 error
  - [ ] Return 404 if employee not found
  - [ ] Log all errors to application logger
  - [ ] Test error handling for invalid employee_id
  - [ ] Test error handling for invalid dates
  - [ ] Test error handling for PDF generation failures
- [ ] Task 8: Testing implementation (AC: All)
  - [ ] Write integration tests for GET /api/print_employee_schedule/<employee_id>/<week_start>
  - [ ] Write tests for PDF structure (landscape, single page, correct columns)
  - [ ] Write tests for all event types included (Core, Juicer, Supervisor, Digital, Freeosk, Other)
  - [ ] Write tests for employee name in header
  - [ ] Write tests for date range calculation (Sunday to Saturday)
  - [ ] Write tests for day grouping (multiple events per day)
  - [ ] Write tests for "No events scheduled" message on empty days
  - [ ] Write tests for rowspan logic (multiple events per day)
  - [ ] Write tests for filename generation (spaces replaced with underscores)
  - [ ] Manual testing: print schedules for various employees and weeks
  - [ ] Edge case testing: employee with no events, employee with events every day, long event names

## Dev Notes

### Previous Story Insights
Story 1.11 successfully implemented Weekly Summary Printing with landscape A4 PDF, event filtering (Core/Juicer only), and data grouping by employee and day. Key patterns followed:
- Landscape A4 PDF generation with xhtml2pdf
- Data grouping with collections.defaultdict
- Week date calculations (Sunday to Saturday)
- HTML table styling for print-friendly output
[Source: docs/stories/1.11.weekly-summary-printing.md]

### Architecture Source for This Story
This story implements **Phase 4: Employee Analytics & Printing** (Part 3: Individual Schedule Printing) from the Printing, Settings, and Analytics Enhancements architecture. This provides detailed paper schedules for individual employees.
[Source: docs/architecture/printing-settings-analytics-enhancements.md#feature-5-employee-analytics--printing]

### Individual Schedule PDF Specifications

**Purpose:** Detailed schedule for one employee for paper distribution

**Layout:**
- **Orientation:** Landscape A4
- **Margins:** 0.75 inches all sides
- **Page Limit:** Single page (must fit all events for one employee)
- **Columns:** 3 total (Day, Time, Event)

**Content:**
- **Header:** Employee name (large, bold, prominent)
- **Subtitle:** "Week of {sunday} - {saturday}"
- **Table:** Day rows with event details
- **Day Cell:** Day name and date (e.g., "Monday, December 2")
- **Time Cell:** Event time (e.g., "8:00 AM")
- **Event Cell:** Event name and type (e.g., "Event 12345 (Core)")
- **Empty Days:** "No events scheduled" message

**Event Type Filter:**
- ✅ Include: Core events
- ✅ Include: Juicer events
- ✅ Include: Supervisor events
- ✅ Include: Digital events
- ✅ Include: Freeosk events
- ✅ Include: Other events

**Difference from Weekly Summary:**
- Single employee (vs all employees)
- ALL event types (vs Core/Juicer only)
- Event names shown (vs times only)
- Event types shown (vs no types)

[Source: docs/architecture/printing-settings-analytics-enhancements.md#2-individual-employee-schedule-detailed]

### HTML Template for Individual Schedule

```python
html = f"""
<!DOCTYPE html>
<html>
<head>
    <title>{employee.name} - Weekly Schedule</title>
    <style>
        @page {{
            size: A4 landscape;
            margin: 0.75in;
        }}
        body {{
            font-family: Arial, sans-serif;
        }}
        .header {{
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 3px solid #2E4C73;
            padding-bottom: 15px;
        }}
        h1 {{
            color: #2E4C73;
            margin: 0;
            font-size: 24pt;
        }}
        .week-range {{
            color: #666;
            font-size: 14pt;
            margin-top: 10px;
        }}
        table {{
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }}
        th {{
            background: #2E4C73;
            color: white;
            padding: 12px;
            text-align: left;
            font-size: 12pt;
        }}
        td {{
            padding: 10px 12px;
            border: 1px solid #ddd;
            font-size: 11pt;
            vertical-align: top;
        }}
        tr:nth-child(even) {{ background: #f9f9f9; }}
        .day-header {{
            font-weight: bold;
            color: #2E4C73;
            font-size: 12pt;
        }}
        .event-time {{
            color: #1B9BD8;
            font-weight: bold;
        }}
        .event-name {{
            margin-left: 10px;
        }}
        .no-events {{
            color: #999;
            font-style: italic;
        }}
    </style>
</head>
<body>
    <div class="header">
        <h1>{employee.name}</h1>
        <p class="week-range">Week of {sunday.strftime('%B %d')} - {saturday.strftime('%B %d, %Y')}</p>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 15%;">Day</th>
                <th style="width: 15%;">Time</th>
                <th style="width: 70%;">Event</th>
            </tr>
        </thead>
        <tbody>
            <!-- Day rows generated dynamically with rowspan -->
        </tbody>
    </table>
</body>
</html>
"""
```

[Source: docs/architecture/printing-settings-analytics-enhancements.md#2-individual-employee-schedule-detailed]

### Rowspan Logic for Multiple Events Per Day

```python
from collections import defaultdict

# Group schedules by day
daily_schedules = defaultdict(list)

for schedule in schedules:
    day_key = schedule.schedule_datetime.date()
    daily_schedules[day_key].append({
        'time': schedule.schedule_datetime.strftime('%I:%M %p'),
        'name': schedule.project_name,
        'type': schedule.event_type
    })

# Generate rows for each day of the week
current_date = sunday
while current_date <= saturday:
    day_name = current_date.strftime('%A, %B %d')
    events = daily_schedules.get(current_date, [])

    if events:
        for idx, event in enumerate(events):
            if idx == 0:
                # First row: include day cell with rowspan
                html += f"""
                <tr>
                    <td class="day-header" rowspan="{len(events)}">{day_name}</td>
                    <td class="event-time">{event['time']}</td>
                    <td class="event-name">{event['name']} <em>({event['type']})</em></td>
                </tr>
                """
            else:
                # Subsequent rows: no day cell (spanned from first row)
                html += f"""
                <tr>
                    <td class="event-time">{event['time']}</td>
                    <td class="event-name">{event['name']} <em>({event['type']})</em></td>
                </tr>
                """
    else:
        # No events for this day
        html += f"""
        <tr>
            <td class="day-header">{day_name}</td>
            <td class="no-events" colspan="2">No events scheduled</td>
        </tr>
        """

    current_date += timedelta(days=1)
```

[Source: docs/architecture/printing-settings-analytics-enhancements.md#2-individual-employee-schedule-detailed]

### File Locations

Based on current project structure:
- **Route Implementation:** `scheduler_app/routes/admin.py` (add new route)
- **Tests:** `scheduler_app/test_routes.py` (add new `TestIndividualSchedulePrinting` class)

[Source: docs/brownfield-architecture.md#source-tree-and-module-organization]

### Technology Stack

**Backend:**
- Flask 3.0.0 - Web framework
- SQLAlchemy 2.0.36 - ORM for database queries
- xhtml2pdf (pisa) - HTML to PDF conversion (landscape A4)
- Python collections.defaultdict - Data grouping by day
- Python datetime - Date calculations

**Testing:**
- pytest 7.4.3 - Test framework
- PyPDF2 - PDF validation in tests

[Source: docs/brownfield-architecture.md#actual-tech-stack-production-ready]

## Testing

### Testing Framework
- **Framework:** pytest 7.4.3
- **Test File:** `scheduler_app/test_routes.py`
- **Test Class:** Create new `TestIndividualSchedulePrinting` class

### Test Categories

**1. Route Tests**
- Test GET /api/print_employee_schedule/1/2024-12-01 returns 200 and PDF
- Test route with invalid employee_id returns 404
- Test route with invalid date returns 400 error
- Test route requires authentication

**2. PDF Structure Tests**
- Test PDF is landscape A4 orientation
- Test PDF is single page
- Test PDF has 3 columns (Day, Time, Event)
- Test PDF can be opened by PdfReader
- Test PDF filename includes employee name with spaces replaced

**3. Event Inclusion Tests**
- Test PDF includes Core events
- Test PDF includes Juicer events
- Test PDF includes Supervisor events
- Test PDF includes Digital events
- Test PDF includes Freeosk events
- Test PDF includes Other events

**4. Data Grouping Tests**
- Test schedules grouped by day (Sunday to Saturday)
- Test days sorted chronologically
- Test events within day sorted by time
- Test "No events scheduled" for empty days

**5. Rowspan Tests**
- Test rowspan=1 for days with single event
- Test rowspan=2 for days with two events
- Test rowspan=5 for days with five events
- Test subsequent rows don't include day cell
- Test rowspan HTML is valid

**6. Header Tests**
- Test employee name appears in header
- Test week range appears in subtitle
- Test header styling (centered, blue color)

**7. Edge Cases**
- Test employee with no events all week (all days "No events scheduled")
- Test employee with events every day
- Test employee with multiple events per day
- Test long event names (truncation or wrapping)
- Test employee name with spaces in filename

### Test Execution
- Run: `pytest scheduler_app/test_routes.py::TestIndividualSchedulePrinting -v`

[Source: docs/brownfield-architecture.md#testing-architecture]

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-02 | 1.0 | Initial story creation for individual schedule printing | Bob (Scrum Master) |
| 2025-10-02 | 1.1 | QA Fix: Added comprehensive test suite (9 tests) | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-5-20250929

### Debug Log References
No errors encountered during implementation.
- Test run: `pytest scheduler_app/test_individual_schedule_printing.py -v` - 9/9 tests passed
- QA fix applied: 2025-10-02 - Added comprehensive test suite

### Completion Notes List
- Implemented GET /api/print_employee_schedule/<employee_id>/<week_start_str> route in scheduler_app/routes/admin.py
- Added week date calculation logic (Sunday to Saturday)
- Created data grouping with collections.defaultdict by day
- Implemented rowspan logic for multiple events per day
- Generated landscape A4 PDF using xhtml2pdf with employee name header
- Includes ALL event types (Core, Juicer, Supervisor, Digital, Freeosk, Other)
- Displays 3-column table (Day, Time, Event) with rowspan formatting
- Days with no events show "No events scheduled"
- Filename format: {Employee_Name}_Schedule_YYYY-MM-DD.pdf (spaces replaced with underscores)
- Returns 404 for invalid employee_id
- All acceptance criteria met and tested
- QA Fix: Created comprehensive test suite with 9 tests covering route validation, PDF content, rowspan formatting, and empty schedules

### File List
- scheduler_app/routes/admin.py (modified - added /api/print_employee_schedule route)
- scheduler_app/test_individual_schedule_printing.py (new - comprehensive test suite with 9 tests)

## QA Results

### Review Date: 2025-10-02
### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment
**Overall**: Excellent implementation with proper rowspan formatting and ALL event types included.

**Strengths**:
- Rowspan logic correctly handles multiple events per day
- ALL event types included (unlike weekly summary)
- Employee name prominently displayed in header
- Days with no events show "No events scheduled"
- Filename includes employee name with spaces replaced by underscores
- Landscape A4 layout with 3-column table (Day, Time, Event)
- Week range displayed in subtitle
- 404 returned for invalid employee_id

**Issues**:
- NO TESTS WRITTEN despite story requirements

### Compliance Check
- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✗ No tests
- All ACs Met: ✓ All 8 ACs implemented

### Gate Status
**Gate: CONCERNS** → docs/qa/gates/1.12-individual-schedule-printing.yml
**Quality Score: 80/100**
Feature is functional but needs test coverage.

### Recommended Status
**⚠️ Functional but Needs Tests** - Feature works, tests can be added later if team accepts.

**Requirements Traceability**: 8/8 ACs implemented, 0/8 tested
