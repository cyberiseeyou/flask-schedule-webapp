<story-context id="flask-schedule-webapp/employee-management-enhancement/3-1" v="1.0">
  <metadata>
    <epicId>epic-3</epicId>
    <storyId>3-1</storyId>
    <title>Crossmark API Integration for Employee Fetch</title>
    <status>drafted</status>
    <generatedAt>2025-11-21</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/sprint-artifacts/3-1-crossmark-api-integration-for-employee-fetch.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>scheduling manager</asA>
    <iWant>the system to fetch available employees from the Crossmark API</iWant>
    <soThat>I can import employee data including MV Retail numbers needed for scheduling</soThat>
    <tasks>
- Task 1: Add fetch_available_reps method to SessionAPIService (if not exists)
- Task 2: Update EmployeeImportService.fetch_crossmark_employees to use Pydantic models
- Task 3: Create import initiation route
- Task 4: Add "Import from Crossmark" button to Employees page
- Task 5: Implement loading spinner/indicator
- Task 6: Add comprehensive tests
    </tasks>
  </story>

  <acceptanceCriteria>
Given: I have a valid Crossmark session (logged in)
When: I click "Import from Crossmark" button on Employees page
Then: the system makes a POST request to https://crossmark.mvretail.com/schedulingcontroller/getAvailableReps
And: the request uses existing session authentication from SessionAPIService
And: the request includes a date range parameter in format "MM/DD/YYYY HH:MM:SS,MM/DD/YYYY HH:MM:SS"
And: the system parses the JSON response into CrossmarkEmployee Pydantic models
And: the fetch completes within 10 seconds for typical datasets (NFR-P2)
And: a loading spinner displays during the API call with message "Fetching employees from Crossmark..."
  </acceptanceCriteria>

  <artifacts>
    <docs>
PRD - Crossmark API Import (FR9-FR12):
- FR9: Users can initiate Crossmark API employee import
- FR10: System authenticates with Crossmark API using existing session management
- FR11: System fetches available employees from API endpoint
- FR12: System extracts and maps employee data from response
- FR32: System displays loading indicator during API fetch
- FR38: System reuses existing Crossmark session authentication

Architecture - Integration Points (lines 148-182): Crossmark API endpoint specification
Architecture - API Contracts (lines 656-681): fetch_available_reps method specification
    </docs>
    <code>
EXISTING API SERVICE (app/integrations/external_api/session_api_service.py):
get_available_representatives method EXISTS (lines 427-482):
```python
def get_available_representatives(self, start_date: datetime = None, end_date: datetime = None) -> Optional[Dict]:
    """Get available representatives for scheduling"""
    # Already implemented - returns JSON response
    # Uses multipart/form-data with 'project' field containing date range
    # Format: "MM/DD/YYYY HH:MM:SS,MM/DD/YYYY HH:MM:SS"
```

EmployeeImportService.fetch_crossmark_employees EXISTS (lines 108-157):
- Currently returns List[dict]
- Needs update to return List[CrossmarkEmployee] (Story 1.3)
- Uses session_api.get_available_representatives

EMPLOYEES ROUTE (app/routes/employees.py):
- Existing route /api/get_available_reps (lines 471-525) fetches from API
- Can be adapted or new route created for import flow
    </code>
    <dependencies>
SessionAPIService - existing authentication and API integration
CrossmarkEmployee Pydantic model (from Story 1.3)
Date range formatting: datetime.strftime("%m/%d/%Y %H:%M:%S")
    </dependencies>
  </artifacts>

  <constraints>
NFR-P2: API fetch must complete within 10 seconds for typical datasets
NFR-S4: Employee data transmission uses HTTPS for all API calls
Session authentication: Must reuse existing SessionAPIService authentication
Date range: Default to current datetime + 7 days ahead
  </constraints>

  <interfaces>
NEW ROUTE: GET /employees/import-crossmark
- Calls EmployeeImportService.fetch_crossmark_employees()
- Returns List[CrossmarkEmployee]
- Handles authentication errors, network errors, validation errors
- Redirects to selection interface (Story 3.3)

BUTTON: "Import from Crossmark" on /employees page
- Triggers GET /employees/import-crossmark
- Shows loading spinner during fetch
- Styled consistently with existing page buttons
  </interfaces>

  <tests>
    <standards>Mock Crossmark API, test authentication, test error handling</standards>
    <locations>tests/test_employee_import_service.py, tests/test_employee_routes.py</locations>
    <ideas>Test successful fetch, test API error, test authentication error, test network timeout, test Pydantic validation error, test loading indicator</ideas>
  </tests>
</story-context>
